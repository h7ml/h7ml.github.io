import{_ as p}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as e,o,c,d as n,e as a,a as t,f as l}from"./app-Cbix2SPG.js";const i={},u=l(`<h2 id="diff-ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#diff-ç®—æ³•"><span>Diff ç®—æ³•</span></a></h2><p><code>Diff</code>ç®—æ³•çš„æ ¸å¿ƒå°±æ˜¯<strong>é’ˆå¯¹å…·æœ‰ç›¸åŒçˆ¶èŠ‚ç‚¹çš„åŒå±‚æ–°æ—§å­èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œè€Œä¸æ˜¯ä½¿ç”¨é€å±‚æœç´¢é€’å½’éå†çš„æ–¹å¼ã€‚æ—¶é—´å¤æ‚åº¦ä¸º<code>O(n)</code></strong>ã€‚</p><p>å¦‚ä½•ç†è§£ï¼Ÿ</p><p>è¯´ç™½ç‚¹ï¼Œå°±æ˜¯<strong>å½“æ–°æ—§<code>VNode</code>æ ‘åœ¨åŒä¸€å±‚å…·æœ‰ç›¸åŒçš„<code>VNode</code>èŠ‚ç‚¹æ—¶ï¼Œæ‰ä¼šç»§ç»­å¯¹å…¶å­èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒ</strong>ã€‚ä¸€æ—¦æ—§<code>VNode</code>æ ‘åŒå±‚ä¸­çš„èŠ‚ç‚¹åœ¨æ–°<code>VNode</code>æ ‘ä¸­ä¸å­˜åœ¨æˆ–è€…æ˜¯å¤šä½™çš„ï¼Œéƒ½ä¼šåœ¨æ–°çš„çœŸå®<code>DOM</code>ä¸­è¿›è¡Œæ·»åŠ æˆ–è€…åˆ é™¤ã€‚</p><p>ä¸‹é¢å°±æ‹¿ä¸€å‰¯å›¾è¿›è¡Œè§£é‡Šã€‚</p><figure><img src="https://static.h7ml.cn/vitepress/assets/images/diff1.jpg" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ä»ä¸Šé¢çš„ç¤ºä¾‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œ<code>Diff</code>ç®—æ³•ä¸­åªä¼šå¯¹åŒä¸€å±‚çš„å…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶ä¸”å¿…é¡»æ‹¥æœ‰ç›¸åŒèŠ‚ç‚¹å…ƒç´ ï¼Œæ‰ä¼šå¯¹å…¶å­èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œå…¶ä»–å¤šä½™çš„åŒå±‚èŠ‚ç‚¹éƒ½ä¼šä¸€å¾‹åšåˆ é™¤æˆ–æ·»åŠ æ“ä½œã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä»æºç è§’åº¦æ¥çœ‹çœ‹è¿™è¿‡ç¨‹åˆ°åº•æ˜¯å¦‚ä½•å‘ç”Ÿçš„ã€‚ğŸ¤”</p><h3 id="diff-æµç¨‹å›¾" tabindex="-1"><a class="header-anchor" href="#diff-æµç¨‹å›¾"><span>diff æµç¨‹å›¾</span></a></h3><p>å½“æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œset æ–¹æ³•ä¼šè®©è°ƒç”¨<code>Dep.notify</code>é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…<code>Watcher</code>ï¼Œè®¢é˜…è€…å°±ä¼šè°ƒç”¨<code>patch</code>ç»™çœŸå®çš„ DOM æ‰“è¡¥ä¸ï¼Œæ›´æ–°ç›¸åº”çš„è§†å›¾ã€‚</p><figure><img src="https://static.h7ml.cn/vitepress/assets/images/diff8.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="ä»æºç è§’åº¦è¿›è¡Œæ¢ç©¶" tabindex="-1"><a class="header-anchor" href="#ä»æºç è§’åº¦è¿›è¡Œæ¢ç©¶"><span>ä»æºç è§’åº¦è¿›è¡Œæ¢ç©¶</span></a></h3><p>æˆ‘ä»¬ä¾ç„¶æ˜¯ä»<code>_update</code>æ–¹æ³•å…¥æ‰‹ï¼Œçœ‹çœ‹åˆ°åº•æ˜¯å¦‚ä½•æ“ä½œçš„ã€‚</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_update</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> hydrating</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// ç¼“å­˜vueå®ä¾‹</span>
  <span class="token keyword">var</span> prevEl <span class="token operator">=</span> vm<span class="token punctuation">.</span>$el<span class="token punctuation">;</span> <span class="token comment">// è·å–å®ä¾‹ä¸­çœŸå®DOMå…ƒç´ </span>
  <span class="token keyword">var</span> prevVnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode<span class="token punctuation">;</span> <span class="token comment">// è·å–æ—§VNodeæ ‘</span>
  vm<span class="token punctuation">.</span>_vnode <span class="token operator">=</span> vnode<span class="token punctuation">;</span> <span class="token comment">// å°†æ–°VNodeæ ‘ä¿å­˜åˆ°å®ä¾‹çš„_vnodeä¸Šï¼Œä¾¿äºä¸‹æ¬¡æ›´æ–°è·å–æ—§VNodeæ ‘</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­æ˜¯å¦æœ‰æ—§VNodeæ ‘ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†</span>
    <span class="token comment">// initial render</span>
    <span class="token comment">// æœ€å¼€å§‹çš„ä¸€æ¬¡ï¼Œå³ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶æ˜¯æ²¡æœ‰æ—§VNodeæ ‘ï¼Œç›´æ¥æ‰§è¡Œ__patch__</span>
    vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* removeOnly */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// updates</span>
    vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>prevVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ–°VNodeæ ‘ä¸æ—§VNodeæ ‘è¿›è¡Œ__patch__</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯ä¸€æ¬¡æ›´æ–°æ¨¡æ¿æ—¶ï¼Œéƒ½ä¼šå…ˆå°†æ¸²æŸ“å¥½çš„æ–°<code>VNode</code>æ ‘ä¿å­˜åˆ°å®ä¾‹çš„<code>_vnode</code>å±æ€§ä¸Šï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†ä¸‹ä¸€æ¬¡æ›´æ–°æ—¶ï¼Œèƒ½è·å–åˆ°æ—§<code>VNode</code>æ ‘è¿›è¡Œæ¯”è¾ƒã€‚</p><p>é’ˆå¯¹æ˜¯å¦æ‹¥æœ‰æ—§çš„<code>VNode</code>æ ‘ï¼Œä½¿ç”¨<code>__patch__</code>æ–¹æ³•æ‰§è¡Œç›¸åº”é€»è¾‘ï¼Œä¹Ÿå³æ‰§è¡Œäº†<code>patch</code>è¿‡ç¨‹ã€‚</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">var</span> inBrowser <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span><span class="token punctuation">;</span> <span class="token comment">// æµè§ˆå™¨ç¯å¢ƒ</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__patch__ <span class="token operator">=</span> inBrowser <span class="token operator">?</span> patch <span class="token operator">:</span> noop<span class="token punctuation">;</span> <span class="token comment">// åªæœ‰åœ¨æµè§ˆå™¨ç¯å¢ƒæ‰èƒ½è¿›è¡Œpatch</span>

<span class="token keyword">var</span> patch <span class="token operator">=</span> <span class="token function">createPatchFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">nodeOps</span><span class="token operator">:</span> nodeOps<span class="token punctuation">,</span> <span class="token literal-property property">modules</span><span class="token operator">:</span> modules <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œ<strong>åªæœ‰åœ¨æµè§ˆå™¨çš„ç¯å¢ƒä¸‹æ‰èƒ½è¿›è¡Œ<code>patch</code>è¿‡ç¨‹</strong>ï¼Œè€Œå®ç°<code>patch</code>çš„ï¼Œå°±æ˜¯<code>createPatchFunction</code>æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥ç€çœ‹ä¸‹å»ã€‚</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createPatchFunction</span><span class="token punctuation">(</span><span class="token parameter">backend</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// çœç•¥äº†å¾ˆå¤šç§æœ‰å·¥å…·æ–¹æ³•ï¼Œä¸‹é¢ä¼šæ‹¿å‡ºä¸€äº›è¿›è¡Œè¯´æ˜</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å½“æ—§VNodeæ ‘ä¸å­˜åœ¨æ—¶ï¼Œåˆ™ç›´æ¥åˆ›å»ºä¸€ä¸ªæ ¹å…ƒç´ </span>
      <span class="token comment">// empty mount (likely as component), create new root element</span>
      isInitialPatch <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç›´æ¥æ ¹æ®æ–°VNodeæ ‘å¹¶ç”ŸæˆçœŸå®DOM</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// å½“å­˜åœ¨æ—§VNodeæ ‘æ—¶ï¼Œåˆ™è¿›è¡Œç›¸åº”çš„æ¯”è¾ƒ</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ–°æ—§èŠ‚ç‚¹æ˜¯ç›¸åŒæ—¶</span>
        <span class="token comment">// patch existing root node</span>
        <span class="token comment">// å½“æ–°æ—§èŠ‚ç‚¹ç›¸åŒæ—¶åˆ™è¿›è¡Œpatchæ¯”è¾ƒ</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ–°æ—§èŠ‚ç‚¹ä¸ç›¸åŒæ—¶</span>
        <span class="token keyword">var</span> oldElm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span> <span class="token comment">// è·å–æ—§èŠ‚ç‚¹å…ƒç´ </span>
        <span class="token keyword">var</span> parentElm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è·å–æ—§èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span>

        <span class="token comment">// create new node</span>
        <span class="token function">createElm</span><span class="token punctuation">(</span>
          <span class="token comment">// ç”±äºæ–°æ—§èŠ‚ç‚¹æ˜¯ä¸åŒçš„ï¼Œå› æ­¤ä¼šæ ¹æ®æ–°èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹</span>
          vnode<span class="token punctuation">,</span>
          insertedVnodeQueue<span class="token punctuation">,</span>
          oldElm<span class="token punctuation">.</span>_leaveCb <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> parentElm<span class="token punctuation">,</span>
          nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// destroy old node</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// åˆ›å»ºå¥½æ–°èŠ‚ç‚¹åï¼Œåˆ é™¤æ—§èŠ‚ç‚¹</span>
          <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// åˆ é™¤å“åº”èŠ‚ç‚¹åï¼Œä¹Ÿä¼šè°ƒç”¨ç›¸åº”çš„å›è°ƒ</span>
          <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¥½å•¦ï¼Œå¯¹äº<code>patch</code>æ¯”è¾ƒè¿‡ç¨‹ï¼Œä½ ä¹Ÿåº”è¯¥æœ‰äº†ä¸€ä¸ªå¤§æ¦‚äº†è§£ã€‚ç°åœ¨å°±æ¥ç®€å•æ€»ç»“ä¸€ä¸‹ä¸Šè¿°ä»£ç ã€‚</p><ul><li>å½“æ—§<code>VNode</code>æ ‘ä¸å­˜åœ¨æ—¶ï¼Œç›´æ¥æ ¹æ®æ–°<code>VNode</code>æ ‘åˆ›å»ºç›¸åº”çš„çœŸå®<code>DOM</code>ã€‚</li><li>å½“æ—§<code>VNode</code>æ ‘å­˜åœ¨æ—¶ï¼Œåˆ™ä¼šè°ƒç”¨<code>sameVnode</code>æ–¹æ³•æ¯”è¾ƒå½“å‰æ–°æ—§èŠ‚ç‚¹æ˜¯å¦ç›¸åŒã€‚ <ul><li>å½“æ–°æ—§èŠ‚ç‚¹æ˜¯ç›¸åŒæ—¶ï¼Œä¼šè°ƒç”¨<code>patchVnode</code>æ–¹æ³•æ¯”è¾ƒæ–°æ—§èŠ‚ç‚¹ï¼ˆè¿‡ç¨‹å°±æ˜¯ç»§ç»­æ¯”è¾ƒå…¶å­èŠ‚ç‚¹ï¼Œé€’å½’ä¸‹å»ï½ï¼‰ã€‚</li><li>å½“æ–°æ—§èŠ‚ç‚¹æ˜¯ä¸åŒæ—¶ï¼Œåˆ™ä¼šå…ˆæŒ‰ç…§æ–°<code>VNode</code>èŠ‚ç‚¹åˆ›å»ºæ–°çš„çœŸå®<code>DOM</code>èŠ‚ç‚¹ï¼Œå†æ ¹æ®æ—§<code>VNode</code>èŠ‚ç‚¹å°†ç›¸åº”çš„çœŸå®<code>DOM</code>èŠ‚ç‚¹è¿›è¡Œåˆ é™¤ã€‚</li></ul></li></ul><p>æ˜¯ä¸æ˜¯å¾ˆç®€å• ğŸ¤”...é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸æ˜¯è¯´<code>patchè¿‡</code>ç¨‹æ˜¯ä½¿ç”¨<code>Diff</code>ç®—æ³•è¿›è¡Œæ¯”è¾ƒçš„å—ï¼Ÿæ€ä¹ˆè¿˜çœ‹ä¸åˆ°ï¼Œç”­æ€¥ï¼Œä¸‹é¢æˆ‘ä¼šè®²åˆ°å“ˆã€‚</p><p>åœ¨ä¸Šé¢çš„æ€»ç»“ä¸­ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯<code>sameVnode</code>æ–¹æ³•å’Œ<code>patchVnode</code>æ–¹æ³•ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥æ¢è®¨ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</p><h3 id="samevnode" tabindex="-1"><a class="header-anchor" href="#samevnode"><span>sameVnode</span></a></h3><p>åˆ¤æ–­ä¸¤ä¸ªèŠ‚ç‚¹é—´æ˜¯å¦ç›¸åŒ</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ¤æ–­ä¸¤ä¸ªèŠ‚ç‚¹é—´æ˜¯å¦ç›¸åŒ</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    a<span class="token punctuation">.</span>key <span class="token operator">===</span> b<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> <span class="token comment">// ä¸¤ä¸ªèŠ‚ç‚¹é—´ç›¸åŒï¼Œé¦–å…ˆæ˜¯å”¯ä¸€æ ‡è¯†keyå¿…é¡»ç›¸åŒ</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>tag <span class="token operator">===</span> b<span class="token punctuation">.</span>tag <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span>isComment <span class="token operator">===</span> b<span class="token punctuation">.</span>isComment <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">isDef</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sameInputType</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token comment">// æ¥ç€å°±æ˜¯èŠ‚ç‚¹æ ‡ç­¾åã€æ˜¯å¦ä¸ºæ³¨é‡Šã€æ•°æ®æ˜¯å¦ä¸ºç©ºã€inputç±»å‹éƒ½å¿…é¡»ç›¸åŒ</span>
      <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>isAsyncPlaceholder<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span>asyncFactory <span class="token operator">===</span> b<span class="token punctuation">.</span>asyncFactory <span class="token operator">&amp;&amp;</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>asyncFactory<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">sameInputType</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ¯”è¾ƒä¸¤ä¸ªèŠ‚ç‚¹çš„inputç±»å‹æ˜¯å¦ç›¸åŒ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token string">&#39;input&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> i<span class="token punctuation">;</span>
  <span class="token keyword">var</span> typeA <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> a<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token keyword">var</span> typeB <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> b<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token keyword">return</span> typeA <span class="token operator">===</span> typeB <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">isTextInputType</span><span class="token punctuation">(</span>typeA<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isTextInputType</span><span class="token punctuation">(</span>typeB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯”è¾ƒä¸¤ä¸ªæ–°æ—§èŠ‚ç‚¹é—´æ˜¯å¾ˆç®€å•çš„ï¼Œä¸»è¦æ˜¯æŒ‰ç…§ä¸‹é¢å‡ ä¸ªå±æ€§è¿›è¡Œåˆ¤æ–­ã€‚</p><ul><li><code>VNode</code>èŠ‚ç‚¹å”¯ä¸€æ ‡è¯†<code>key</code>ã€‚</li><li>æ˜¯å¦åŒä¸ºæ³¨é‡Š<code>isComment</code>ã€‚</li><li>æ•°æ®å±æ€§æ˜¯å¦ä¸ºç©º<code>isDef</code>ã€‚</li><li>æ˜¯å¦ä¸ºç›¸åŒçš„<code>input</code>ç±»å‹<code>sameInputType</code>ã€‚</li></ul><h3 id="patchvnode" tabindex="-1"><a class="header-anchor" href="#patchvnode"><span>patchVnode</span></a></h3><p>å¥½å•¦ï¼Œæ¥ç€å°±åˆ°æˆ‘ä»¬çš„ä¸»è§’<code>patchVnode</code>æ–¹æ³•äº†ï¼Œè¿™ä¸ªæ‰æ˜¯<code>Diff</code>ç›¸å…³æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æºç æ˜¯å¦‚ä½•å®ç°çš„ã€‚ğŸ¤”</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">patchVnode</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> ownerArray<span class="token punctuation">,</span> index<span class="token punctuation">,</span> removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å½“å‘ç°ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯å®Œå…¨ä¸€æ¨¡ä¸€æ ·æ—¶ï¼Œåˆ™ç›´æ¥è¿”å›</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">var</span> elm <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">var</span> i<span class="token punctuation">;</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>prepatch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ ¹æ®æ–°VNodeæ›´æ–°æ—§VNodeçš„é€‰é¡¹é…ç½®ã€æ•°æ®å±æ€§ã€propsDataç­‰</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children<span class="token punctuation">;</span> <span class="token comment">// è·å–oldVNodeçš„å­èŠ‚ç‚¹é›†åˆ</span>
  <span class="token keyword">var</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">;</span> <span class="token comment">// è·å–VNodeçš„å­èŠ‚ç‚¹é›†åˆ</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å½“VNodeä¸ä¸ºæ–‡æœ¬èŠ‚ç‚¹æ—¶</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å½“oldVNodeçš„å­èŠ‚ç‚¹å’ŒVNodeçš„å­èŠ‚ç‚¹éƒ½ä¸ä¸ºç©ºæ—¶</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å½“oldVNodeçš„å­èŠ‚ç‚¹å’ŒVNodeçš„å­èŠ‚ç‚¹ä¸ç­‰æ—¶ï¼Œå†é€’å½’æ‰§è¡ŒupdateChildrenæ¯”è¾ƒå­èŠ‚ç‚¹</span>
        <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å½“åªæœ‰VNodeçš„å­èŠ‚ç‚¹å­˜åœ¨è€ŒoldVNodeçš„å­èŠ‚ç‚¹ä¸å­˜åœ¨æ—¶</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å½“oldVNodeä¸ºæ–‡æœ¬èŠ‚ç‚¹æ—¶ï¼Œå…ˆç½®ç©ºæ–‡æœ¬</span>
        nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ ¹æ®ä½ç½®å¯¹çœŸå®DOMæ·»åŠ æ–°çš„èŠ‚ç‚¹</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å½“oldVNodeçš„å­èŠ‚ç‚¹å­˜åœ¨, è€ŒVNodeçš„å­èŠ‚ç‚¹ä¸å­˜åœ¨æ—¶</span>
      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç›´æ¥ç§»é™¤æ‰€æœ‰å¤šä½™èŠ‚ç‚¹</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å½“åªæœ‰oldVNodeçš„å­èŠ‚ç‚¹å­˜åœ¨,å¹¶ä¸”æ˜¯æ–‡æœ¬èŠ‚ç‚¹æ—¶</span>
      nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç›´æ¥ç½®ç©ºæ–‡æœ¬å¤„ç†</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å½“oldVNodeæ–‡æœ¬èŠ‚ç‚¹ä¸ç­‰äºVNodeæ–‡æœ¬èŠ‚ç‚¹æ—¶</span>
    nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç›´æ¥å°†oldVNodeèŠ‚ç‚¹è®¾ç½®ä¸ºVNodeèŠ‚ç‚¹æ–‡æœ¬å†…å®¹</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>patchVnode</code>æ–¹æ³•åšçš„äº‹æƒ…ä¸å¤šï¼Œæœ€ä¸»è¦å°±æ˜¯æŒ‰ç…§ä¸€ä¸‹åœºæ™¯åšäº†å¤„ç†;</p><p><code>diff</code>è¿‡ç¨‹ä¸­åˆåˆ†äº†å¥½å‡ ç§æƒ…å†µï¼Œ<code>oldCh</code> ä¸º <code>oldVnode</code>çš„å­èŠ‚ç‚¹ï¼Œ<code>ch</code> ä¸º <code>Vnode</code>çš„å­èŠ‚ç‚¹ï¼š</p><ul><li>é¦–å…ˆè¿›è¡Œæ–‡æœ¬èŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œè‹¥ <code>oldVnode.text !== vnode.text</code>ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥è¿›è¡Œæ–‡æœ¬èŠ‚ç‚¹çš„æ›¿æ¢ï¼›</li><li><code>åœ¨vnode</code>æ²¡æœ‰æ–‡æœ¬èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œè¿›å…¥å­èŠ‚ç‚¹çš„ <code>diff</code>ï¼›</li><li>å½“ <code>oldCh</code> å’Œ <code>ch</code> éƒ½å­˜åœ¨ä¸”ä¸ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨ <code>updateChildren</code> å¯¹å­èŠ‚ç‚¹è¿›è¡Œ <code>diff</code>ï¼›</li><li>è‹¥ <code>oldCh</code>ä¸å­˜åœ¨ï¼Œ<code>ch</code> å­˜åœ¨ï¼Œé¦–å…ˆæ¸…ç©º <code>oldVnode</code> çš„æ–‡æœ¬èŠ‚ç‚¹ï¼ŒåŒæ—¶è°ƒç”¨ <code>addVnodes</code> æ–¹æ³•å°† <code>ch</code> æ·»åŠ åˆ°<code>elm</code>çœŸå® dom èŠ‚ç‚¹å½“ä¸­ï¼›</li><li>è‹¥ <code>oldCh</code>å­˜åœ¨ï¼Œ<code>ch</code>ä¸å­˜åœ¨ï¼Œåˆ™åˆ é™¤ <code>elm</code> çœŸå®èŠ‚ç‚¹ä¸‹çš„ <code>oldCh</code> å­èŠ‚ç‚¹ï¼›</li><li>è‹¥ <code>oldVnode</code> æœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼Œè€Œ <code>vnode</code> æ²¡æœ‰ï¼Œé‚£ä¹ˆå°±æ¸…ç©ºè¿™ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚</li></ul><p>æ¥ä¸‹æ¥æ‰æ˜¯æœ€é‡ç‚¹å‘€ã€‚ã€‚ğŸ˜… åœ¨ä¸Šé¢ä¸­ç•™ä¸‹äº†<code>updateChildren</code>æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•åˆæ˜¯å¹²å•¥ï¼Ÿ</p><p>ä¸ç’ä½ è¯´ï¼Œ<code>updateChildren</code>æ–¹æ³•åœ¨æ ¹æ®åœºæ™¯<code>Diff</code>åï¼Œå°†<code>oldVNode</code>æ ‘ä½œå‡ºç›¸åº”çš„æ”¹åŠ¨ã€‚åœ¨æ²¡æœ‰çœ‹æºç ä¹‹å‰ï¼Œæˆ‘ä¼šå…ˆé˜è¿°ä¸€ä¸‹ã€‚</p><p><code>Diffç®—æ³•</code>è¿‡ç¨‹ä¸­ï¼Œåœ¨å°†<code>oldVNode</code>æ ‘æ”¹åŠ¨æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘ç›¸åŒä½ç½®çš„ç›¸åŒèŠ‚ç‚¹ï¼Œå†è€ƒè™‘éœ€è¦ç§»åŠ¨çš„ç›¸åŒèŠ‚ç‚¹ï¼Œæœ€åæ‰è€ƒè™‘åˆ›å»ºæˆ–åˆ é™¤èŠ‚ç‚¹ã€‚</p><h3 id="updatechildren" tabindex="-1"><a class="header-anchor" href="#updatechildren"><span>updateChildren</span></a></h3><p>æœ‰äº†ä¸Šé¢çš„ç®€å•ç†è§£ï¼Œæˆ‘ä»¬å°±æ¥ç»§ç»­æ¢ç©¶å•¦ ğŸ˜„ã€‚</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// æ—§èŠ‚ç‚¹å¼€å§‹ä½ç½®</span>
  <span class="token keyword">var</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// æ–°èŠ‚ç‚¹å¼€å§‹ä½ç½®</span>
  <span class="token keyword">var</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// æ—§èŠ‚ç‚¹ç»“æŸä½ç½®</span>
  <span class="token keyword">var</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// æ—§èŠ‚ç‚¹ç¬¬ä¸€ä¸ªå…ƒç´ </span>
  <span class="token keyword">var</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// æ—§èŠ‚ç‚¹æœ€åä¸€ä¸ªå…ƒç´ </span>
  <span class="token keyword">var</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// æ–°èŠ‚ç‚¹ç»“æŸä½ç½®</span>
  <span class="token keyword">var</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// æ–°èŠ‚ç‚¹ç¬¬ä¸€ä¸ªå…ƒç´ </span>
  <span class="token keyword">var</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// æ–°èŠ‚ç‚¹æœ€åä¸€ä¸ªå…ƒç´ </span>
  <span class="token keyword">var</span> oldKeyToIdx<span class="token punctuation">,</span> idxInOld<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">,</span> refElm<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åŒæ—¶ä»æ–°æ—§å­èŠ‚ç‚¹é›†åˆå¼€å§‹éå†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä»ç¬¬ä¸€é¡¹å¼€å§‹ï¼Œä¸€ç›´éå†æ—§èŠ‚ç‚¹åˆå§‹å…ƒç´ ç›´åˆ°ä¸ä¸ºç©ºä¸ºæ­¢</span>
      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Vnode has been moved left</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä»æœ€åä¸€é¡¹å¼€å§‹ï¼Œä¸€ç›´éå†æ—§èŠ‚ç‚¹ç›´åˆ°ä¸ä¸ºç©ºä¸ºæ­¢</span>
      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ï¼ˆç›¸åŒä½ç½®åœºæ™¯ï¼‰å½“ç¬¬ä¸€é¡¹æ—§èŠ‚ç‚¹å’Œç¬¬ä¸€é¡¹æ–°èŠ‚ç‚¹ç›¸åŒæ—¶ï¼Œåˆ™ç»§ç»­æ‰§è¡ŒpatchVnodeé€’å½’æ‰§è¡Œä¸‹å»</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ï¼ˆç›¸åŒä½ç½®åœºæ™¯ï¼‰å½“æœ€åä¸€é¡¹æ—§èŠ‚ç‚¹å’Œæœ€åä¸€é¡¹æ–°èŠ‚ç‚¹ç›¸åŒæ—¶ï¼Œåˆ™ç»§ç»­æ‰§è¡ŒpatchVnodeé€’å½’æ‰§è¡Œä¸‹å»</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ï¼ˆéœ€è¦ç§»åŠ¨åœºæ™¯ï¼‰å½“ç¬¬ä¸€é¡¹æ—§èŠ‚ç‚¹å’Œæœ€åä¸€é¡¹æ–°èŠ‚ç‚¹ç›¸åŒæ—¶ï¼Œå…ˆæ‰§è¡ŒpatchVnodeé€’å½’æ‰§è¡Œä¸‹å»ï¼Œå†æ‰§è¡ŒinsertBeforeå°†çœŸå®DOMèŠ‚ç‚¹æ’å…¥åˆ°ç›¸åº”ä½ç½®</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ï¼ˆéœ€è¦ç§»åŠ¨åœºæ™¯ï¼‰å½“æœ€åä¸€é¡¹æ—§èŠ‚ç‚¹å’Œç¬¬ä¸€é¡¹æ–°èŠ‚ç‚¹ç›¸åŒæ—¶ï¼Œå…ˆæ‰§è¡ŒpatchVnodeé€’å½’æ‰§è¡Œä¸‹å»ï¼Œå†æ‰§è¡ŒinsertBeforeå°†çœŸå®DOMèŠ‚ç‚¹æ’å…¥åˆ°ç›¸åº”ä½ç½®</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ¯”è¾ƒå¤´å°¾éƒ½æ— ç›¸åŒå…ƒç´ æ—¶ï¼Œç›´æ¥åˆ¤æ–­æ–°èŠ‚ç‚¹æ˜¯å¦åœ¨æ—§èŠ‚ç‚¹ç»“åˆä¸­ï¼Œè‹¥æœ‰åˆ™ç›´æ¥ç§»åŠ¨ç›¸åº”çš„ä½ç½®ï¼Œè‹¥æ— åˆ™ç›´æ¥æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldKeyToIdx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token comment">// å°†æ—§èŠ‚ç‚¹ç»“åˆåˆ›å»ºä¸€ä¸ªå“ˆå¸Œè¡¨</span>
      idxInOld <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
        <span class="token operator">?</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span>
        <span class="token operator">:</span> <span class="token function">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ ¹æ®å“ˆå¸Œè¡¨ï¼Œåˆ¤æ–­æ–°èŠ‚ç‚¹æ˜¯å¦åœ¨å“ˆå¸Œè¡¨ä¸­ï¼Œå¹¶è·å¾—å¯¹åº”æ—§èŠ‚ç‚¹çš„ç´¢å¼•ä½ç½®</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å½“æ–°èŠ‚ç‚¹ä¸åœ¨æ—§èŠ‚ç‚¹é›†åˆä¸­æ—¶ï¼Œæ–°å»ºä¸€ä¸ªçœŸå®DOMèŠ‚ç‚¹</span>
        <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// å½“æ–°èŠ‚ç‚¹åœ¨æ—§èŠ‚ç‚¹é›†åˆä¸­æ—¶ï¼Œåˆ™ä¼šå…ˆåˆ¤æ–­ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯å¦ç›¸åŒ</span>
        vnodeToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// æ ¹æ®ç´¢å¼•ä½ç½®è·å¾—æ—§èŠ‚ç‚¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// å½“ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯ç›¸åŒæ—¶ï¼Œç»§ç»­æ‰§è¡ŒpatchVnodeé€’å½’æ‰§è¡Œä¸‹å»ï¼Œå†æ‰§è¡ŒinsertBeforeå°†çœŸå®DOMèŠ‚ç‚¹æ’å…¥åˆ°ç›¸åº”ä½ç½®</span>
          <span class="token function">patchVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
          oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
          canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// å½“ä¸¤ä¸ªèŠ‚ç‚¹ä¸åŒæ—¶ï¼Œç›´æ¥æ–°å»ºä¸€ä¸ªæ–°çš„DOMèŠ‚ç‚¹</span>
          <span class="token comment">// same key but different element. treat as new element</span>
          <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&gt;</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·³å‡ºå¾ªç¯åï¼Œè‹¥æ–°èŠ‚ç‚¹ä¾æ—§å­˜åœ¨ï¼Œé‚£ä¹ˆå°±è¦éå†å‰©ä½™çš„æ–°èŠ‚ç‚¹å¹¶é€ä¸ªæ–°å¢åˆ°çœŸå®DOMä¸­</span>
    refElm <span class="token operator">=</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
    <span class="token function">addVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartIdx <span class="token operator">&gt;</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·³å‡ºå¾ªç¯åï¼Œè‹¥æ—§èŠ‚ç‚¹ä¾æ—§å­˜åœ¨ï¼Œé‚£ä¹ˆå°±è¦å°†çœŸå®DOMä¸­å¯¹åº”æ—§VNodeèŠ‚ç‚¹è¿›è¡Œåˆ é™¤æ“ä½œ</span>
    <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å…·ä½“çš„-diff-åˆ†æ" tabindex="-1"><a class="header-anchor" href="#å…·ä½“çš„-diff-åˆ†æ"><span>å…·ä½“çš„ diff åˆ†æ</span></a></h3><p>æˆ‘ä»¬å¯ä»¥å‡è®¾æœ‰æ—§çš„ Vnode æ•°ç»„å’Œæ–°çš„ Vnode æ•°ç»„è¿™ä¸¤ä¸ªæ•°ç»„,è€Œä¸”æœ‰å››ä¸ªå˜é‡å……å½“æŒ‡é’ˆåˆ†åˆ«æŒ‡åˆ°ä¸¤ä¸ªæ•°ç»„çš„å¤´å°¾.</p><p>é‡å¤ä¸‹é¢çš„å¯¹æ¯”è¿‡ç¨‹ï¼Œç›´åˆ°ä¸¤ä¸ªæ•°ç»„ä¸­ä»»ä¸€æ•°ç»„çš„å¤´æŒ‡é’ˆè¶…è¿‡å°¾æŒ‡é’ˆï¼Œå¾ªç¯ç»“æŸ :</p><ul><li>å¤´å¤´å¯¹æ¯”: å¯¹æ¯”ä¸¤ä¸ªæ•°ç»„çš„å¤´éƒ¨ï¼Œå¦‚æœæ‰¾åˆ°ï¼ŒæŠŠæ–°èŠ‚ç‚¹ patch åˆ°æ—§èŠ‚ç‚¹ï¼Œå¤´æŒ‡é’ˆåç§»</li><li>å°¾å°¾å¯¹æ¯”: å¯¹æ¯”ä¸¤ä¸ªæ•°ç»„çš„å°¾éƒ¨ï¼Œå¦‚æœæ‰¾åˆ°ï¼ŒæŠŠæ–°èŠ‚ç‚¹ patch åˆ°æ—§èŠ‚ç‚¹ï¼Œå°¾æŒ‡é’ˆå‰ç§»</li><li>æ—§å°¾æ–°å¤´å¯¹æ¯”: äº¤å‰å¯¹æ¯”ï¼Œæ—§å°¾æ–°å¤´ï¼Œå¦‚æœæ‰¾åˆ°ï¼ŒæŠŠæ–°èŠ‚ç‚¹ patch åˆ°æ—§èŠ‚ç‚¹ï¼Œæ—§å°¾æŒ‡é’ˆå‰ç§»ï¼Œæ–°å¤´æŒ‡é’ˆåç§»</li><li>æ—§å¤´æ–°å°¾å¯¹æ¯”: äº¤å‰å¯¹æ¯”ï¼Œæ—§å¤´æ–°å°¾ï¼Œå¦‚æœæ‰¾åˆ°ï¼ŒæŠŠæ–°èŠ‚ç‚¹ patch åˆ°æ—§èŠ‚ç‚¹ï¼Œæ–°å°¾æŒ‡é’ˆå‰ç§»ï¼Œæ—§å¤´æŒ‡é’ˆåç§»</li><li>åˆ©ç”¨ key å¯¹æ¯”: ç”¨æ–°æŒ‡é’ˆå¯¹åº”èŠ‚ç‚¹çš„ key å»æ—§æ•°ç»„å¯»æ‰¾å¯¹åº”çš„èŠ‚ç‚¹,è¿™é‡Œåˆ†ä¸‰ç§æƒ…å†µ,å½“æ²¡æœ‰å¯¹åº”çš„ keyï¼Œé‚£ä¹ˆåˆ›å»ºæ–°çš„èŠ‚ç‚¹,å¦‚æœæœ‰ key å¹¶ä¸”æ˜¯ç›¸åŒçš„èŠ‚ç‚¹ï¼ŒæŠŠæ–°èŠ‚ç‚¹ patch åˆ°æ—§èŠ‚ç‚¹,å¦‚æœæœ‰ key ä½†æ˜¯ä¸æ˜¯ç›¸åŒçš„èŠ‚ç‚¹ï¼Œåˆ™åˆ›å»ºæ–°èŠ‚ç‚¹</li></ul><p>æˆ‘ä»¬å‡è®¾æœ‰æ–°æ—§ä¸¤ä¸ªæ•°ç»„:</p><ul><li>æ—§æ•°ç»„: <code>[1, 2, 3, 4, 5]</code></li><li>æ–°æ•°ç»„: <code>[1, 4, 6, 1000, 100, 5]</code></li></ul><figure><img src="https://static.h7ml.cn/vitepress/assets/images/diff2.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>é¦–å…ˆæˆ‘ä»¬è¿›è¡Œå¤´å¤´å¯¹æ¯”,æ–°æ—§æ•°ç»„çš„å¤´éƒ¨éƒ½æ˜¯<code>1</code>,å› æ­¤å°†åŒæ–¹çš„å¤´éƒ¨æŒ‡é’ˆåç§».</p><figure><img src="https://static.h7ml.cn/vitepress/assets/images/diff3.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æˆ‘ä»¬ç»§ç»­å¤´å¤´å¯¹æ¯”,ä½†æ˜¯<code>2 !== 4</code>å¯¼è‡´å¯¹æ¯”å¤±è´¥,æˆ‘è¿›å…¥å°¾å°¾å¯¹æ¯”,<code>5 === 5</code>,é‚£ä¹ˆå°¾éƒ¨æŒ‡é’ˆåˆ™å¯å‰ç§».</p><figure><img src="https://static.h7ml.cn/vitepress/assets/images/diff4.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ç°åœ¨è¿›å…¥æ–°çš„å¾ªç¯,å¤´å¤´å¯¹æ¯”<code>2 !== 4</code>,å°¾å°¾å¯¹æ¯”<code>4 !== 100</code>,æ­¤æ—¶è¿›å…¥äº¤å‰å¯¹æ¯”,å…ˆè¿›è¡Œæ—§å°¾æ–°å¤´å¯¹æ¯”,å³<code>4 === 4</code>,æ—§å°¾å‰ç§»ä¸”æ–°å¤´åç§».</p><figure><img src="https://static.h7ml.cn/vitepress/assets/images/diff5.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æ¥ç€å†è¿›å…¥ä¸€ä¸ªè½®æ–°çš„å¾ªç¯,å¤´å¤´å¯¹æ¯”<code>2 !== 6</code>,å°¾å°¾å¯¹æ¯”<code>3 !== 100</code>,äº¤å‰å¯¹æ¯”<code>2 != 100 3 != 6</code>,å››ç§å¯¹æ¯”æ–¹å¼å…¨éƒ¨ä¸ç¬¦åˆ,å¦‚æœè¿™ä¸ªæ—¶å€™éœ€è¦é€šè¿‡<code>key</code>å»å¯¹æ¯”,ç„¶åå°†æ–°å¤´æŒ‡é’ˆåç§»</p><figure><img src="https://static.h7ml.cn/vitepress/assets/images/diff6.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ç»§ç»­é‡å¤ä¸Šè¿°å¯¹æ¯”çš„å¾ªç¯æ–¹å¼ç›´è‡³ä»»ä¸€æ•°ç»„çš„å¤´æŒ‡é’ˆè¶…è¿‡å°¾æŒ‡é’ˆï¼Œå¾ªç¯ç»“æŸ.</p><figure><img src="https://static.h7ml.cn/vitepress/assets/images/diff7.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>åœ¨ä¸Šè¿°å¾ªç¯ç»“æŸå,ä¸¤ä¸ªæ•°ç»„ä¸­å¯èƒ½å­˜åœ¨æœªéå†å®Œçš„æƒ…å†µ: å¾ªç¯ç»“æŸåï¼Œ</p><ul><li>å…ˆå¯¹æ¯”æ—§æ•°ç»„çš„å¤´å°¾æŒ‡é’ˆï¼Œå¦‚æœæ—§æ•°ç»„éå†å®Œäº†ï¼ˆå¯èƒ½æ–°æ•°ç»„æ²¡éå†å®Œï¼Œæœ‰æ¼æ·»åŠ çš„é—®é¢˜ï¼‰ï¼Œæ·»åŠ æ–°æ•°ç»„ä¸­æ¼æ‰çš„èŠ‚ç‚¹</li><li>å†å¯¹æ¯”æ–°æ•°ç»„çš„å¤´å°¾æŒ‡é’ˆï¼Œå¦‚æœæ–°æ•°ç»„éå†å®Œäº†ï¼ˆå¯èƒ½æ—§æ•°ç»„æ²¡éå†å®Œï¼Œæœ‰æ¼åˆ é™¤çš„é—®é¢˜ï¼‰ï¼Œåˆ é™¤æ—§æ•°ç»„ä¸­æ¼æ‰çš„èŠ‚ç‚¹</li></ul><h3 id="å‚è€ƒ" tabindex="-1"><a class="header-anchor" href="#å‚è€ƒ"><span>å‚è€ƒ</span></a></h3>`,60),d={href:"https://juejin.im/post/5d36cc575188257aea108a74",target:"_blank",rel:"noopener noreferrer"},k={href:"https://github.com/aooy/blog/issues/2",target:"_blank",rel:"noopener noreferrer"},r={href:"https://juejin.im/post/5affd01551882542c83301da",target:"_blank",rel:"noopener noreferrer"},m={href:"https://juejin.im/post/5d3f3bf36fb9a06af824b3e2#heading-5",target:"_blank",rel:"noopener noreferrer"},v={href:"https://github.com/Andraw-lin/about-Vue/blob/master/docs/%E3%80%90%20Vue%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%20%E3%80%91%E5%A6%82%E4%BD%95%E5%9C%A8%E6%9B%B4%E6%96%B0%20Patch%20%E4%B8%AD%E8%BF%9B%E8%A1%8C%20Diff.md",target:"_blank",rel:"noopener noreferrer"};function f(b,h){const s=e("ExternalLinkIcon");return o(),c("div",null,[u,n("ul",null,[n("li",null,[n("a",d,[a("Vue æ ¸å¿ƒä¹‹è™šæ‹Ÿ DOM"),t(s)])]),n("li",null,[n("a",k,[a("è§£æ vue2.0 çš„ diff ç®—æ³•"),t(s)])]),n("li",null,[n("a",r,[a("è¯¦è§£ vue çš„ diff ç®—æ³•"),t(s)])]),n("li",null,[n("a",m,[a("é¢è¯•å®˜: ä½ å¯¹è™šæ‹Ÿ DOM åŸç†çš„ç†è§£?"),t(s)])]),n("li",null,[n("a",v,[a("ã€ Vue æºç åˆ†æ ã€‘å¦‚ä½•åœ¨æ›´æ–° Patch ä¸­è¿›è¡Œ Diff.md"),t(s)])])])])}const g=p(i,[["render",f],["__file","diff.html.vue"]]),w=JSON.parse('{"path":"/posts/vue/diff.html","title":"diff","lang":"zh-CN","frontmatter":{"icon":"vue","order":3,"date":"2021-07-12T00:00:00.000Z","author":"h7ml","title":"diff","category":"vue","tag":["vue","diff"],"star":true,"lastUpdated":false,"description":"Diff ç®—æ³• Diffç®—æ³•çš„æ ¸å¿ƒå°±æ˜¯é’ˆå¯¹å…·æœ‰ç›¸åŒçˆ¶èŠ‚ç‚¹çš„åŒå±‚æ–°æ—§å­èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œè€Œä¸æ˜¯ä½¿ç”¨é€å±‚æœç´¢é€’å½’éå†çš„æ–¹å¼ã€‚æ—¶é—´å¤æ‚åº¦ä¸ºO(n)ã€‚ å¦‚ä½•ç†è§£ï¼Ÿ è¯´ç™½ç‚¹ï¼Œå°±æ˜¯å½“æ–°æ—§VNodeæ ‘åœ¨åŒä¸€å±‚å…·æœ‰ç›¸åŒçš„VNodeèŠ‚ç‚¹æ—¶ï¼Œæ‰ä¼šç»§ç»­å¯¹å…¶å­èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒã€‚ä¸€æ—¦æ—§VNodeæ ‘åŒå±‚ä¸­çš„èŠ‚ç‚¹åœ¨æ–°VNodeæ ‘ä¸­ä¸å­˜åœ¨æˆ–è€…æ˜¯å¤šä½™çš„ï¼Œéƒ½ä¼šåœ¨æ–°çš„çœŸå®DOMä¸­è¿›è¡Œæ·»åŠ æˆ–è€…åˆ é™¤ã€‚...","head":[["link",{"rel":"canonical","href":"https://www.h7ml.cn/posts/vue/diff.html"}],["meta",{"property":"og:url","content":"https://www.h7ml.cn/posts/vue/diff.html"}],["meta",{"property":"og:site_name","content":"h7ml-å‰ç«¯ç‰©è¯­"}],["meta",{"property":"og:title","content":"diff"}],["meta",{"property":"og:description","content":"Diff ç®—æ³• Diffç®—æ³•çš„æ ¸å¿ƒå°±æ˜¯é’ˆå¯¹å…·æœ‰ç›¸åŒçˆ¶èŠ‚ç‚¹çš„åŒå±‚æ–°æ—§å­èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œè€Œä¸æ˜¯ä½¿ç”¨é€å±‚æœç´¢é€’å½’éå†çš„æ–¹å¼ã€‚æ—¶é—´å¤æ‚åº¦ä¸ºO(n)ã€‚ å¦‚ä½•ç†è§£ï¼Ÿ è¯´ç™½ç‚¹ï¼Œå°±æ˜¯å½“æ–°æ—§VNodeæ ‘åœ¨åŒä¸€å±‚å…·æœ‰ç›¸åŒçš„VNodeèŠ‚ç‚¹æ—¶ï¼Œæ‰ä¼šç»§ç»­å¯¹å…¶å­èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒã€‚ä¸€æ—¦æ—§VNodeæ ‘åŒå±‚ä¸­çš„èŠ‚ç‚¹åœ¨æ–°VNodeæ ‘ä¸­ä¸å­˜åœ¨æˆ–è€…æ˜¯å¤šä½™çš„ï¼Œéƒ½ä¼šåœ¨æ–°çš„çœŸå®DOMä¸­è¿›è¡Œæ·»åŠ æˆ–è€…åˆ é™¤ã€‚..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://static.h7ml.cn/vitepress/assets/images/diff1.jpg"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2023-05-03T04:52:44.000Z"}],["meta",{"property":"article:author","content":"h7ml"}],["meta",{"property":"article:tag","content":"vue"}],["meta",{"property":"article:tag","content":"diff"}],["meta",{"property":"article:published_time","content":"2021-07-12T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2023-05-03T04:52:44.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"diff\\",\\"image\\":[\\"https://static.h7ml.cn/vitepress/assets/images/diff1.jpg\\",\\"https://static.h7ml.cn/vitepress/assets/images/diff8.png\\",\\"https://static.h7ml.cn/vitepress/assets/images/diff2.png\\",\\"https://static.h7ml.cn/vitepress/assets/images/diff3.png\\",\\"https://static.h7ml.cn/vitepress/assets/images/diff4.png\\",\\"https://static.h7ml.cn/vitepress/assets/images/diff5.png\\",\\"https://static.h7ml.cn/vitepress/assets/images/diff6.png\\",\\"https://static.h7ml.cn/vitepress/assets/images/diff7.png\\"],\\"datePublished\\":\\"2021-07-12T00:00:00.000Z\\",\\"dateModified\\":\\"2023-05-03T04:52:44.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"h7ml\\"}]}"]]},"headers":[{"level":2,"title":"Diff ç®—æ³•","slug":"diff-ç®—æ³•","link":"#diff-ç®—æ³•","children":[{"level":3,"title":"diff æµç¨‹å›¾","slug":"diff-æµç¨‹å›¾","link":"#diff-æµç¨‹å›¾","children":[]},{"level":3,"title":"ä»æºç è§’åº¦è¿›è¡Œæ¢ç©¶","slug":"ä»æºç è§’åº¦è¿›è¡Œæ¢ç©¶","link":"#ä»æºç è§’åº¦è¿›è¡Œæ¢ç©¶","children":[]},{"level":3,"title":"sameVnode","slug":"samevnode","link":"#samevnode","children":[]},{"level":3,"title":"patchVnode","slug":"patchvnode","link":"#patchvnode","children":[]},{"level":3,"title":"updateChildren","slug":"updatechildren","link":"#updatechildren","children":[]},{"level":3,"title":"å…·ä½“çš„ diff åˆ†æ","slug":"å…·ä½“çš„-diff-åˆ†æ","link":"#å…·ä½“çš„-diff-åˆ†æ","children":[]},{"level":3,"title":"å‚è€ƒ","slug":"å‚è€ƒ","link":"#å‚è€ƒ","children":[]}]}],"git":{"createdTime":1683089564000,"updatedTime":1683089564000,"contributors":[{"name":"h7ml","email":"h7ml@qq.com","commits":1}]},"readingTime":{"minutes":12.64,"words":3793},"filePathRelative":"posts/vue/diff.md","localizedDate":"2021å¹´7æœˆ12æ—¥","excerpt":"<h2>Diff ç®—æ³•</h2>\\n<p><code>Diff</code>ç®—æ³•çš„æ ¸å¿ƒå°±æ˜¯<strong>é’ˆå¯¹å…·æœ‰ç›¸åŒçˆ¶èŠ‚ç‚¹çš„åŒå±‚æ–°æ—§å­èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œè€Œä¸æ˜¯ä½¿ç”¨é€å±‚æœç´¢é€’å½’éå†çš„æ–¹å¼ã€‚æ—¶é—´å¤æ‚åº¦ä¸º<code>O(n)</code></strong>ã€‚</p>\\n<p>å¦‚ä½•ç†è§£ï¼Ÿ</p>\\n<p>è¯´ç™½ç‚¹ï¼Œå°±æ˜¯<strong>å½“æ–°æ—§<code>VNode</code>æ ‘åœ¨åŒä¸€å±‚å…·æœ‰ç›¸åŒçš„<code>VNode</code>èŠ‚ç‚¹æ—¶ï¼Œæ‰ä¼šç»§ç»­å¯¹å…¶å­èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒ</strong>ã€‚ä¸€æ—¦æ—§<code>VNode</code>æ ‘åŒå±‚ä¸­çš„èŠ‚ç‚¹åœ¨æ–°<code>VNode</code>æ ‘ä¸­ä¸å­˜åœ¨æˆ–è€…æ˜¯å¤šä½™çš„ï¼Œéƒ½ä¼šåœ¨æ–°çš„çœŸå®<code>DOM</code>ä¸­è¿›è¡Œæ·»åŠ æˆ–è€…åˆ é™¤ã€‚</p>","autoDesc":true}');export{g as comp,w as data};
