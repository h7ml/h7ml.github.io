<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.32" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="canonical" href="https://www.h7ml.cn/posts/graphics/konva.html"><meta property="og:url" content="https://www.h7ml.cn/posts/graphics/konva.html"><meta property="og:site_name" content="h7ml-前端物语"><meta property="og:title" content="konva"><meta property="og:description" content="konva 前言 用过 Canvas 的都知道它的 API 比较多，使用起来也很麻烦，比如我想绘制一个圆形就要调一堆 API，对开发算不上友好。 为了解决这个痛点，诞生了例如 PIXI、ZRender、Fabric 等 Canvas 库。今天要讲的 Konva 也是一个很优秀的 Canvas 框架，API 封装简洁易懂，基于 TypeScript 实现..."><meta property="og:type" content="article"><meta property="og:image" content="https://camo.githubusercontent.com/f9afa6e7475eb6ffdf610aeae294ab6678a51e1a45ef71b05e2f583c1f0144f1/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f36373130386631382d303239312d346138312d613336312d3735653565626462366539642e706e67"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-05-03T04:52:44.000Z"><meta property="article:author" content="h7ml"><meta property="article:tag" content="graphics"><meta property="article:published_time" content="2021-01-17T00:00:00.000Z"><meta property="article:modified_time" content="2023-05-03T04:52:44.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"konva","image":["https://camo.githubusercontent.com/f9afa6e7475eb6ffdf610aeae294ab6678a51e1a45ef71b05e2f583c1f0144f1/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f36373130386631382d303239312d346138312d613336312d3735653565626462366539642e706e67","https://camo.githubusercontent.com/29a78d23111ca442579c11ed9c56d8d8f50288dcf9e99bc6128e0a8de0470f71/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f34333435323935312d386131372d343665642d613136302d6563343065393234396132322e706e67","https://camo.githubusercontent.com/4828d368c32e74643cbb46d198154e8d11830dc3610a082b9eca3f624f09449f/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f30343531323865362d303637332d343535662d383739302d6335336437346365353662622e706e67","https://camo.githubusercontent.com/5aa09e0b1727de6052f80f44d0dd13736059acfe0e84bb681cb09cc4f4d01ec5/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f63613061646131612d613263322d343363322d626262362d3534353264323365343534362e706e67","https://camo.githubusercontent.com/b9b5d26a9416879dc1be928551640eba483b5af33a0af809def5f2b2fc6a5fea/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f32393861326332322d363837332d343464352d393234662d3331306461343239313931302e706e67","https://camo.githubusercontent.com/a462a32aa3f2bf7f01f52a225069d66a35b7ffbb9de0320ec7bfabb81a21b2e0/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f34663139613934392d303035372d346434632d393032342d3561633637373838663239382e706e67","https://camo.githubusercontent.com/56f41e90923fd22589829ba27314071b45fccabf3584bd84fef6096769120833/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f33353666323635322d663831332d343434362d393265612d3563383735363035303631342e706e67","https://camo.githubusercontent.com/e975ab71150c628666949ce3803e1e6d50e6045bd370850de3e2ae65f495aa20/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f36396264363065342d306335302d346465662d613564372d3665303531393761323663392e706e67","https://camo.githubusercontent.com/352ea8233908db8e9464a7b814deb15ebf770b61c171ca4067da513109f29deb/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f35333735653761642d393835332d343236302d613265312d6631633263643738366662642e706e67","https://camo.githubusercontent.com/821609f511a6cd1760042d9fea1d66ce53deabed1e2628df0683b73e898cba16/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f62376437653336382d643833622d343765342d613234382d3734613732306133656665632e706e67","https://camo.githubusercontent.com/5736b6469b94b56d537b2a76c8999e3b307278d42527a4bb7f4d87f2b68357cd/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f39346434613735622d626262362d343861312d623036302d6165376530386164626130382e706e67","https://camo.githubusercontent.com/695f54a7f71577ec66604e45270bc623eabb928e823bcce2b564d636de17997a/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f64333463333963632d386464312d346239382d613933332d6533633338303164643739332e706e67","https://camo.githubusercontent.com/0c8f0933195af9f1afa41f3f2a373158a101454f3c36c8a585eee32337a9f33c/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f63616536613739652d623937312d343238392d393432652d6536303539366537303432362e706e67"],"datePublished":"2021-01-17T00:00:00.000Z","dateModified":"2023-05-03T04:52:44.000Z","author":[{"@type":"Person","name":"h7ml"}]}</script><meta name="keywords" content="前端物语、h7ml博客、VuePress、JavaScript、CSS、HTML5、MySQL、Docker、Redis、Nginx、Python、Go、PHP"><meta name="description" content="h7ml是一个专注于前端物语的VuePress博客，致力于分享前端开发的技术和经验。我们涵盖了JavaScript、CSS、HTML5、MySQL等多个方面的编程实践和学习笔记，旨在帮助前端开发者提高技能水平和解决实际问题。此外，我们也开源了多个项目，欢迎加入我们的社区，一起探索前端开发的世界！"><meta name="baidu-site-verification" content="code-Lp1igULfj7"><meta name="sogou_site_verification" content="BWYVlXjMMm"><meta name="shenma-site-verification" content="ee99e8921fe7309289e832fd8b02b3c4_1675848238"><meta name="360-site-verification" content="d429aed2ee74fc7e9fd3e2321ce178a7"><meta name="google-site-verification" content="aY4x14jxZErrVd-FCPVQDhEjk9A_kKf9Cav8QDDVi98"><meta name="X-UA-Compatible" content="X-UA-Compatible"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"><link rel="stylesheet" href="//at.alicdn.com/t/font_2410206_mfj6e1vbwo.css"><link type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/zui/1.8.1/css/zui.min.css"><script src="https://hm.baidu.com/hm.js?35afc12d4ac49f5dd49db387044b8cd0"></script><script src="http://code.jquery.com/jquery-1.11.0.min.js"></script><script src="//www.h7ml.cn/js/nav.js"></script><script defer data-cf-beacon="{"token": "911315c7f2124900844d4c0ae0249528"}" src="https://static.cloudflareinsights.com/beacon.min.js"></script><script defer data-cf-beacon="{"token": "f3347d2b3600448fbb01c0db81477724"}" src="https://static.cloudflareinsights.com/beacon.min.js"></script><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js?id=JztvXshEfC72l41d&ck=JztvXshEfC72l41d&autoTrack=true&hashMode=true"></script><script crossorigin="anonymous" src="https://sdk.51.la/perf/js-sdk-perf.min.js"></script><script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JztvXshEfC72l41d/quote.js?theme=2&f=12&display=0,1,1,1,1,1,1,1"></script><link rel="alternate" type="application/atom+xml" href="https://www.h7ml.cn/atom.xml" title="h7ml-前端物语 Atom Feed"><link rel="alternate" type="application/json" href="https://www.h7ml.cn/feed.json" title="h7ml-前端物语 JSON Feed"><link rel="alternate" type="application/rss+xml" href="https://www.h7ml.cn/rss.xml" title="h7ml-前端物语 RSS Feed"><title>konva | h7ml-前端物语</title>
    <link rel="preload" href="/assets/style-C_yFhrBP.css" as="style"><link rel="stylesheet" href="/assets/style-C_yFhrBP.css">
    <link rel="modulepreload" href="/assets/app-Cbix2SPG.js"><link rel="modulepreload" href="/assets/konva.html-DiujZYZT.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">h7ml-前端物语</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/" aria-label="前端物语"><span class="font-icon icon iconfont icon-home" style=""></span>前端物语<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端博文"><span class="title"><span class="font-icon icon iconfont icon-edit" style=""></span>前端博文</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/posts/interview/" aria-label="面试物语"><span class="font-icon icon iconfont icon-diagram" style=""></span>面试物语<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/designPattern/" aria-label="设计模式"><span class="font-icon icon iconfont icon-diagram" style=""></span>设计模式<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/mysql/" aria-label="mysql"><span class="font-icon icon iconfont icon-mysql" style=""></span>mysql<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/PostgreSQL/" aria-label="PostgreSQL"><span class="font-icon icon iconfont icon-workingDirectory" style=""></span>PostgreSQL<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/Nestjs/" aria-label="Nestjs"><span class="font-icon icon iconfont icon-generic" style=""></span>Nestjs<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/docker/" aria-label="docker"><span class="font-icon icon iconfont icon-box" style=""></span>docker<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/rxjava/" aria-label="rxjava"><span class="font-icon icon iconfont icon-java" style=""></span>rxjava<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/redis/" aria-label="redis"><span class="font-icon icon iconfont icon-app" style=""></span>redis<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/javascript/" aria-label="javascript"><span class="font-icon icon iconfont icon-javascript" style=""></span>javascript<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/ecmascript/" aria-label="ecmascript6"><span class="font-icon icon iconfont icon-workingDirectory" style=""></span>ecmascript6<!----></a></li><li class="dropdown-item"><a class="route-link nav-link active" href="/posts/graphics/" aria-label="图形学"><span class="font-icon icon iconfont icon-card" style=""></span>图形学<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/git.html" aria-label="Git"><span class="font-icon icon iconfont icon-git" style=""></span>Git<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/es6.html" aria-label="es6"><span class="font-icon icon iconfont icon-direction" style=""></span>es6<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/github/" aria-label="github"><span class="font-icon icon iconfont icon-github" style=""></span>github<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/engineering/" aria-label="工程化"><span class="font-icon icon iconfont icon-proposal" style=""></span>工程化<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/vue/" aria-label="vue"><span class="font-icon icon iconfont icon-vue" style=""></span>vue<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/vite/" aria-label="vite"><span class="font-icon icon iconfont icon-vue" style=""></span>vite<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/react/" aria-label="react"><span class="font-icon icon iconfont icon-react" style=""></span>react<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/linux/" aria-label="linux"><span class="font-icon icon iconfont icon-linux" style=""></span>linux<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/nginx/" aria-label="nginx"><span class="font-icon icon iconfont icon-nginx" style=""></span>nginx<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/navicat/" aria-label="navicat"><span class="font-icon icon iconfont icon-navigate" style=""></span>navicat<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/python/" aria-label="python"><span class="font-icon icon iconfont icon-python" style=""></span>python<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/posts/Pdf/" aria-label="PDF"><span class="font-icon icon iconfont icon-PDF" style=""></span>PDF<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端工具"><span class="title"><span class="font-icon icon iconfont icon-tool" style=""></span>前端工具</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="https://ChatGpt.h7ml.cn?q=h7ml.cn" rel="noopener noreferrer" target="_blank" aria-label="ChatGpt" class="nav-link"><span class="font-icon icon iconfont icon-module" style=""></span>ChatGpt<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://ide.h7ml.cn?q=h7ml" rel="noopener noreferrer" target="_blank" aria-label="Web Ide" class="nav-link"><span class="font-icon icon iconfont icon-light" style=""></span>Web Ide<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://www.h7ml.cn/nav.html" rel="noopener noreferrer" target="_blank" aria-label="Web Nav" class="nav-link"><span class="font-icon icon iconfont icon-navbar" style=""></span>Web Nav<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/h7ml/h7ml" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><span class="font-icon icon iconfont icon-note" style=""></span><span class="vp-sidebar-title">文章</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/es6.html" aria-label="es6"><span class="font-icon icon iconfont icon-direction" style=""></span>es6<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/git.html" aria-label="Git"><span class="font-icon icon iconfont icon-git" style=""></span>Git<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-github" style=""></span><span class="vp-sidebar-title">github</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-javascript" style=""></span><span class="vp-sidebar-title">javascript</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-mysql" style=""></span><span class="vp-sidebar-title">mysql</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-pdf" style=""></span><span class="vp-sidebar-title">前端物语|面试物语-pdf</span><span class="vp-arrow end"></span></button><!----></section></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/module.html" aria-label="模块化"><span class="font-icon icon iconfont icon-module" style=""></span>模块化<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/browser.html" aria-label="浏览器知识"><span class="font-icon icon iconfont icon-chrome" style=""></span>浏览器知识<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-diagram" style=""></span><span class="vp-sidebar-title">设计模式</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-diagram" style=""></span><span class="vp-sidebar-title">面试物语</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-box" style=""></span><span class="vp-sidebar-title">docker</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-box" style=""></span><span class="vp-sidebar-title">redis</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-box" style=""></span><span class="vp-sidebar-title">rxjava</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><span class="font-icon icon iconfont icon-card" style=""></span><span class="vp-sidebar-title">图形学</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/graphics/svg.html" aria-label="svg"><span class="font-icon icon iconfont icon-card" style=""></span>svg<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/graphics/canvas.html" aria-label="canvas"><span class="font-icon icon iconfont icon-card" style=""></span>canvas<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/graphics/webgl.html" aria-label="webgl"><span class="font-icon icon iconfont icon-card" style=""></span>webgl<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/graphics/erharts.html" aria-label="erharts"><span class="font-icon icon iconfont icon-card" style=""></span>erharts<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/graphics/baiduMap.html" aria-label="baiduMap"><span class="font-icon icon iconfont icon-card" style=""></span>baiduMap<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/graphics/openlayers.html" aria-label="openlayers"><span class="font-icon icon iconfont icon-card" style=""></span>openlayers<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/graphics/three.html" aria-label="three"><span class="font-icon icon iconfont icon-card" style=""></span>three<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/graphics/fabric.html" aria-label="fabric"><span class="font-icon icon iconfont icon-card" style=""></span>fabric<!----></a></li><li><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/posts/graphics/konva.html" aria-label="konva"><span class="font-icon icon iconfont icon-card" style=""></span>konva<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-proposal" style=""></span><span class="vp-sidebar-title">工程化</span><span class="vp-arrow end"></span></button><!----></section></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/js-engine.html" aria-label="前端物语|如何编写JavaScript引擎？"><span class="font-icon icon iconfont icon-question" style=""></span>前端物语|如何编写JavaScript引擎？<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-vue" style=""></span><span class="vp-sidebar-title">vue</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-vue" style=""></span><span class="vp-sidebar-title">vite</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-react" style=""></span><span class="vp-sidebar-title">react</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-nginx" style=""></span><span class="vp-sidebar-title">nginx</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-python" style=""></span><span class="vp-sidebar-title">python</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Apple</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Banana</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Coding</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Ecmascript</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Full Stack Tale</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Html</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-linux" style=""></span><span class="vp-sidebar-title">Linux 基础操作</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-navigate" style=""></span><span class="vp-sidebar-title">navicat</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-generic" style=""></span><span class="vp-sidebar-title">Nestjs</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-workingDirectory" style=""></span><span class="vp-sidebar-title">PostgreSQL的语法知识和常见查询操作</span><span class="vp-arrow end"></span></button><!----></section></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/cherry.html" aria-label="樱桃"><span class="font-icon icon iconfont icon-pen-to-square" style=""></span>樱桃<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/dragonfruit.html" aria-label="火龙果"><span class="font-icon icon iconfont icon-pen-to-square" style=""></span>火龙果<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/tomato.html" aria-label="番茄"><span class="font-icon icon iconfont icon-pen-to-square" style=""></span>番茄<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/strawberry.html" aria-label="草莓"><span class="font-icon icon iconfont icon-pen-to-square" style=""></span>草莓<!----></a></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><span class="font-icon icon iconfont icon-card" style=""></span>konva</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">h7ml</span></span><span property="author" content="h7ml"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2021-01-17T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 17 分钟</span><meta property="timeRequired" content="PT17M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category4 clickable" role="navigation">graphics</span><!--]--><meta property="articleSection" content="graphics"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag4 clickable" role="navigation">graphics</span><!--]--><meta property="keywords" content="graphics"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!--[--><!----><!--]--><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#前言">前言</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#架构设计">架构设计</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#konva-tree">Konva Tree</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#build-dom">build dom</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#渲染">渲染</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#批量渲染">批量渲染</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#shape-绘制">Shape 绘制</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#离屏渲染">离屏渲染</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#perfectdrawenabled">perfectDrawEnabled</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#事件">事件</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#事件分发">事件分发</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#匹配-shape">匹配 Shape</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#自定义-hitfunc">自定义 hitFunc</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#拖拽事件">拖拽事件</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#滤镜">滤镜</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#选择器">选择器</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#序列化">序列化</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#react">React</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#react-reconciler">react-reconciler</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#react-konva">react-konva</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#vue-konva">vue-konva</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#缺陷">缺陷</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#脏矩形">脏矩形</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="konva" tabindex="-1"><a class="header-anchor" href="#konva"><span>konva</span></a></h1><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><p>用过 Canvas 的都知道它的 API 比较多，使用起来也很麻烦，比如我想绘制一个圆形就要调一堆 API，对开发算不上友好。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> context <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;2d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置字体样式</span>
context<span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token string">&#39;24px SimSun, Songti SC&#39;</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span><span class="token string">&#39;24px的宋体呈现&#39;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 绘制完整圆</span>
context<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&#39;RGB(255, 0, 0)&#39;</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了解决这个痛点，诞生了例如 PIXI、ZRender、Fabric 等 Canvas 库。今天要讲的 Konva 也是一个很优秀的 Canvas 框架，API 封装简洁易懂，基于 TypeScript 实现，有 React 和 Vue 版本。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">const</span> stage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Konva<span class="token punctuation">.</span>Stage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">container</span><span class="token operator">:</span> <span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> layer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Konva<span class="token punctuation">.</span>Layer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Konva<span class="token punctuation">.</span>Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Konva<span class="token punctuation">.</span>Text</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">&#39;Hello, this is some good text&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">fontSize</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> circle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Konva<span class="token punctuation">.</span>Circle</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">x</span><span class="token operator">:</span> stage<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token literal-property property">y</span><span class="token operator">:</span> stage<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token literal-property property">radius</span><span class="token operator">:</span> <span class="token number">70</span><span class="token punctuation">,</span>
  <span class="token literal-property property">fill</span><span class="token operator">:</span> <span class="token string">&#39;red&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">stroke</span><span class="token operator">:</span> <span class="token string">&#39;black&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">strokeWidth</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
group<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
group<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>circle<span class="token punctuation">)</span><span class="token punctuation">;</span>
layer<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
stage<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="架构设计" tabindex="-1"><a class="header-anchor" href="#架构设计"><span>架构设计</span></a></h2><h3 id="konva-tree" tabindex="-1"><a class="header-anchor" href="#konva-tree"><span>Konva Tree</span></a></h3><p>从前言里面给的那段代码可以看出来，Konva 有一定的嵌套结构，有些类似 DOM 结构。通过 add 和 remove 就能实现子节点的添加和删除。 <img src="https://camo.githubusercontent.com/f9afa6e7475eb6ffdf610aeae294ab6678a51e1a45ef71b05e2f583c1f0144f1/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f36373130386631382d303239312d346138312d613336312d3735653565626462366539642e706e67" alt="" loading="lazy"> Konva Tree 主要包括这么几部分：</p><ol><li>Stage 根节点：这是应用的根节点，会创建一个 div 节点，作为事件的接收层，根据事件触发时的坐标来分发出去。一个 Stage 节点可以包含多个 Layer 图层。</li><li>Layer 图层：Layer 里面会创建一个 Canvas 节点，主要作用就是绘制 Canvas 里面的元素。一个 Layer 可以包含多个 Group 和 Shape。</li><li>Group 组：Group 包含多个 Shape，如果对其进行变换和滤镜，里面所有的 Shape 都会生效。</li><li>Shape：指 Text、Rect、Circle 等图形，这些是 Konva 封装好的类。 <img src="https://camo.githubusercontent.com/29a78d23111ca442579c11ed9c56d8d8f50288dcf9e99bc6128e0a8de0470f71/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f34333435323935312d386131372d343665642d613136302d6563343065393234396132322e706e67" alt="" loading="lazy"></li></ol><h3 id="build-dom" tabindex="-1"><a class="header-anchor" href="#build-dom"><span>build dom</span></a></h3><p>Stage 创建的时候会去创建两个 Canvas 节点以及 content 容器节点，这两个 Canvas 节点是用于 perfectDrawEnabled 的，后面会讲到。这里需要注意的就是这个 content 节点，作为整个 Konva 画布的容器，之后的 Layer 都会被 append 进去。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  <span class="token function">_buildDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bufferCanvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SceneCanvas</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bufferHitCanvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HitCanvas</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">pixelRatio</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Konva<span class="token punctuation">.</span>isBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> container <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token string">&#39;Stage has no container. A container is required.&#39;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// clear content inside container</span>
    container<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>

    <span class="token comment">// content</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">&#39;relative&#39;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span>style<span class="token punctuation">.</span>userSelect <span class="token operator">=</span> <span class="token string">&#39;none&#39;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">&#39;konvajs-content&#39;</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;role&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;presentation&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resizeDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在调用 Stage.add 的时候，不仅会调用 Layer 的绘制方法，还会把 Layer 的 Canvas 节点 append 进去。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">layer</span><span class="token operator">:</span> Layer<span class="token punctuation">,</span> <span class="token operator">...</span>rest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> length <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token constant">MAX_LAYERS_NUMBER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Util<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">&#39;The stage has &#39;</span> <span class="token operator">+</span>
          length <span class="token operator">+</span>
          <span class="token string">&#39; layers. Recommended maximum number of layers is 3-5. Adding more layers into the stage may drop the performance. Rethink your tree structure, you can use Konva.Group.&#39;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    layer<span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// draw layer and append canvas to container</span>
    layer<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Konva<span class="token punctuation">.</span>isBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>layer<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>_canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// chainable</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="渲染" tabindex="-1"><a class="header-anchor" href="#渲染"><span>渲染</span></a></h2><h3 id="批量渲染" tabindex="-1"><a class="header-anchor" href="#批量渲染"><span>批量渲染</span></a></h3><p>从前面的代码中可以看到，没有手动调用绘制方法，但依然会进行绘制，说明会在一定的时机进行渲染。 这个时机就在 add 方法里面，不管 Group、Layer、Stage 哪个先 add，最终都会触发渲染。他们三个都继承了 Container 类，在 Container 类里面有一个 add 方法，我们来一探究竟。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>children<span class="token operator">:</span> ChildType<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> child <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果要添加的子节点已经有个父节点，那就先将其从父节点移除，再插入到当前节点里面</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      child<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_validateAdd</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置子节点的 index 和 parent</span>
    child<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    child<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    child<span class="token punctuation">.</span><span class="token function">_clearCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_fire</span><span class="token punctuation">(</span><span class="token string">&#39;add&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">child</span><span class="token operator">:</span> child<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 请求绘制</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_requestDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>除了一些常规的处理之外，渲染的关键就在 <code>_requestDraw</code> 方法里面。这里调用了 Layer 上面的 <code>batchDraw</code> 进行批量重绘。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  <span class="token function">_requestDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Konva<span class="token punctuation">.</span>autoDrawEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> drawNode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      drawNode<span class="token operator">?.</span><span class="token function">batchDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个批量重绘的原理是利用 requestAnimationFrame 方法将要绘制的内容放到下一帧来绘制。这样同时修改多个图形多个属性就不需要反复绘制了。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  <span class="token function">batchDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// _waitingForDraw 保证只会执行一次 requestAnimFrame</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_waitingForDraw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_waitingForDraw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果调用多次方法修改 Shape 属性，这里就会批量绘制</span>
      <span class="token comment">// 避免了多次绘制带来的开销</span>
      Util<span class="token punctuation">.</span><span class="token function">requestAnimFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_waitingForDraw <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="shape-绘制" tabindex="-1"><a class="header-anchor" href="#shape-绘制"><span>Shape 绘制</span></a></h3><p>所有涉及到图形绘制的地方都是调用 Shape 实现类上的 <code>_sceneFunc</code> 方法，以 Circle 为例：</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  <span class="token function">_sceneFunc</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>attrs<span class="token punctuation">.</span>radius <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">fillStrokeShape</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 Shape 和 Node 两个基类上面只负责调用，具体的实现放到具体的 Shape 实现上面。这样带来两个好处，一个是可以实现自定义图形，另一个是以后要是支持 SVG、WebGL 会很方便。</p><h3 id="离屏渲染" tabindex="-1"><a class="header-anchor" href="#离屏渲染"><span>离屏渲染</span></a></h3><p>什么是离屏渲染？就是在屏幕之外预渲染一个 Canvas，之后通过 drawImage 的形式将其绘制到屏幕要显示的 Canvas 上面，对形状相似或者重复的对象绘制性能提升非常高。假设我们有个列表页，每次滚动的时候全部重新绘制开销会比较大。但如果我们实现一个 Canvas 池，把已经绘制过的列表项存起来。下次滚动到这里的时候，就可以直接从 Canvas 池里面取出来 drawImage 到页面上了。在 Node 类上面有个 cache 方法，这个方法可以实现细粒度的离屏渲染。 cache 方法内部会创建三个 canvas，分别是：</p><ol><li>cachedSceneCanvas：用于绘制图形的 canvas 的离屏渲染。</li><li>cachedFilterCanvas：用于处理滤镜效果。</li><li>cachedHitCanvas：用于处理 hitCanvas 的离屏渲染。</li></ol><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  <span class="token function">_drawCachedSceneCanvas</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">context</span><span class="token operator">:</span> Context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">_applyOpacity</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">_applyGlobalCompositeOperation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取离屏的 Canvas</span>
    <span class="token keyword">const</span> canvasCache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getCanvasCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>canvasCache<span class="token punctuation">.</span>x<span class="token punctuation">,</span> canvasCache<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> cacheCanvas <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getCachedSceneCanvas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> ratio <span class="token operator">=</span> cacheCanvas<span class="token punctuation">.</span>pixelRatio<span class="token punctuation">;</span>
    <span class="token comment">// 将离屏 Canvas 绘制到要展示的 Canvas 上面</span>
    context<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>
      cacheCanvas<span class="token punctuation">.</span>_canvas<span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span>
      cacheCanvas<span class="token punctuation">.</span>width <span class="token operator">/</span> ratio<span class="token punctuation">,</span>
      cacheCanvas<span class="token punctuation">.</span>height <span class="token operator">/</span> ratio
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="perfectdrawenabled" tabindex="-1"><a class="header-anchor" href="#perfectdrawenabled"><span>perfectDrawEnabled</span></a></h3><p>Canvas 在绘制 stroke 和 fill 的时候，如果遇到透明度的时候，stroke 会和 fill 的一部分重合到一起，就不符合我们的预期了。比如下面这段代码：</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bufferCanvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bufferCtx <span class="token operator">=</span> bufferCanvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;2d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;2d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ctx<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">&#39;green&#39;</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span>lineWidth <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">strokeRect</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span>globalAlpha <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&#39;RGB(255, 0, 0)&#39;</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它的实际展示效果是这样的，中间的 stroke 和 fill 有一部分重叠。 <img src="https://camo.githubusercontent.com/4828d368c32e74643cbb46d198154e8d11830dc3610a082b9eca3f624f09449f/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f30343531323865362d303637332d343535662d383739302d6335336437346365353662622e706e67" alt="" loading="lazy"> 在这种情况下，KonvaJS 实现了一个 perfectDrawEnabled 功能，它会这样做：</p><ol><li>在 bufferCanvas 上绘制 Shape</li><li>绘制 fill 和 stroke</li><li>在 layer 上应用透明度</li><li>将 bufferCanvas 绘制到 sceneCanvas 上面可以看到开启 perfectDrawEnabled 和关闭 perfectDrawEnabled 的区别很明显： <img src="https://camo.githubusercontent.com/5aa09e0b1727de6052f80f44d0dd13736059acfe0e84bb681cb09cc4f4d01ec5/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f63613061646131612d613263322d343363322d626262362d3534353264323365343534362e706e67" alt="" loading="lazy"> 它会在 Stage 里面创建一个 bufferCanvas 和 bufferHitCanvas，前者就是针对 sceneCanvas 的，后者是针对 hitCanvas 的。在 Shape 的 drawScene 方法里面，会判断是否使用 bufferCanvas：</li></ol><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// if buffer canvas is needed</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_useBufferCanvas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skipBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  stage <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bufferCanvas <span class="token operator">=</span> stage<span class="token punctuation">.</span>bufferCanvas<span class="token punctuation">;</span>
  bufferContext <span class="token operator">=</span> bufferCanvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bufferContext<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bufferContext<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bufferContext<span class="token punctuation">.</span><span class="token function">_applyLineJoin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// layer might be undefined if we are using cache before adding to layer</span>
  <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAbsoluteTransform</span><span class="token punctuation">(</span>top<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bufferContext<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>o<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> o<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> o<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> o<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> o<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> o<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 在 bufferCanvas 绘制 fill 和 stroke</span>
  <span class="token function">drawFunc</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> bufferContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bufferContext<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> ratio <span class="token operator">=</span> bufferCanvas<span class="token punctuation">.</span>pixelRatio<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasShadow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span><span class="token function">_applyShadow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 在 sceneCanvas 应用透明度</span>
  context<span class="token punctuation">.</span><span class="token function">_applyOpacity</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span><span class="token function">_applyGlobalCompositeOperation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将 bufferCanvas 绘制到 sceneCanvas</span>
  context<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>bufferCanvas<span class="token punctuation">.</span>_canvas<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bufferCanvas<span class="token punctuation">.</span>width <span class="token operator">/</span> ratio<span class="token punctuation">,</span> bufferCanvas<span class="token punctuation">.</span>height <span class="token operator">/</span> ratio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="事件" tabindex="-1"><a class="header-anchor" href="#事件"><span>事件</span></a></h2><p>Konva 里面的事件是在 Canvas 外层创建了一个 div 节点，在这个节点上面接收了 DOM 事件，再根据坐标点来判断当前点击的是哪个 Shape，然后进行事件分发。所以关键就在如何判断当前点击的 Shape 是哪个？相比 ZRender 里面比较复杂的计算，Konva 使用了一个相当巧妙的方式。</p><h3 id="事件分发" tabindex="-1"><a class="header-anchor" href="#事件分发"><span>事件分发</span></a></h3><p>Konva 目前支持下面这么多事件，EVENTS 是 <code>事件名-事件处理方法</code> 的映射。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token constant">EVENTS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token constant">MOUSEENTER</span><span class="token punctuation">,</span> <span class="token string">&#39;_pointerenter&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">MOUSEDOWN</span><span class="token punctuation">,</span> <span class="token string">&#39;_pointerdown&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">MOUSEMOVE</span><span class="token punctuation">,</span> <span class="token string">&#39;_pointermove&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">MOUSEUP</span><span class="token punctuation">,</span> <span class="token string">&#39;_pointerup&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">MOUSELEAVE</span><span class="token punctuation">,</span> <span class="token string">&#39;_pointerleave&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">TOUCHSTART</span><span class="token punctuation">,</span> <span class="token string">&#39;_pointerdown&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">TOUCHMOVE</span><span class="token punctuation">,</span> <span class="token string">&#39;_pointermove&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">TOUCHEND</span><span class="token punctuation">,</span> <span class="token string">&#39;_pointerup&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">TOUCHCANCEL</span><span class="token punctuation">,</span> <span class="token string">&#39;_pointercancel&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">MOUSEOVER</span><span class="token punctuation">,</span> <span class="token string">&#39;_pointerover&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">WHEEL</span><span class="token punctuation">,</span> <span class="token string">&#39;_wheel&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">CONTEXTMENU</span><span class="token punctuation">,</span> <span class="token string">&#39;_contextmenu&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">POINTERDOWN</span><span class="token punctuation">,</span> <span class="token string">&#39;_pointerdown&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">POINTERMOVE</span><span class="token punctuation">,</span> <span class="token string">&#39;_pointermove&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">POINTERUP</span><span class="token punctuation">,</span> <span class="token string">&#39;_pointerup&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">POINTERCANCEL</span><span class="token punctuation">,</span> <span class="token string">&#39;_pointercancel&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token constant">LOSTPOINTERCAPTURE</span><span class="token punctuation">,</span> <span class="token string">&#39;_lostpointercapture&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 绑定事件</span>
  <span class="token function">_bindContentEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Konva<span class="token punctuation">.</span>isBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token constant">EVENTS</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>event<span class="token punctuation">,</span> methodName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
      <span class="token comment">// 事件绑定在 content 这个 dom 节点上面</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span>methodName<span class="token punctuation">]</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们以 mousedown 这个具体的事件作为例子来分析，它的处理方法在 <code>_pointerdown</code> 里面。 <code>_pointerdown</code> 先执行了 <code>setPointersPositions</code>，计算当前鼠标点击的坐标，减去 content 相对页面的坐标，得到了当前点击相对于 content 的坐标。同时将其存入了 <code>_changedPointerPositions</code> 里面。 <img src="https://camo.githubusercontent.com/b9b5d26a9416879dc1be928551640eba483b5af33a0af809def5f2b2fc6a5fea/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f32393861326332322d363837332d343464352d393234662d3331306461343239313931302e706e67" alt="" loading="lazy"> 然后遍历 <code>_changedPointerPositions</code>，通过 <code>getIntersection</code> 获取到了点击的 Shape 图形。这个 <code>getIntersection</code> 遍历调用了每个 Layer 的 <code>getIntersection</code> 方法，通过 Layer 获取到了对应的 Shape。因为可以存在多个 Layer，每个 Layer 也可以在同一个位置绘制多个 Shape，所以理论上可以获取到多个 Shape，Konva 这里只取了第一个 Shape，按照 Layer -Shape 的顺序来的。 <img src="https://camo.githubusercontent.com/a462a32aa3f2bf7f01f52a225069d66a35b7ffbb9de0320ec7bfabb81a21b2e0/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f34663139613934392d303035372d346434632d393032342d3561633637373838663239382e706e67" alt="" loading="lazy"> 然后 Stage 会调用 Shape 上面的 <code>_fireAndBubble</code> 方法，这个方法调用 <code>_fire</code> 发送 Konva 自己的事件，此时通过 on 绑定的事件回调就会触发，有点儿像 jQuery 那样。然后 Konva 会继续往上找到父节点，继续调用父节点的 <code>_fireAndBubble</code> 方法，直到再也找不到父节点为止，这样就实现了事件冒泡。对于不想被点击到的 Shape 来说，可以设置 <code>isListening</code> 属性为 false，这样事件就不会触发了。</p><h3 id="匹配-shape" tabindex="-1"><a class="header-anchor" href="#匹配-shape"><span>匹配 Shape</span></a></h3><p>那么 Layer 是怎么根据点击坐标获取到对应的 Shape 呢？如果是规则的图形（矩形、圆形）还比较容易计算，要是下面这种不规则图形呢？ <img src="https://camo.githubusercontent.com/56f41e90923fd22589829ba27314071b45fccabf3584bd84fef6096769120833/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f33353666323635322d663831332d343434362d393265612d3563383735363035303631342e706e67" alt="" loading="lazy"> 众所周知，在 Canvas 里面有个 <code>getImageData</code> 方法，它会根据传入的坐标来返回一个 ImageData 信息，里面有当前坐标对应的色值。那么我们能不能根据这个色值来获取到对应的 Shape 呢？ <img src="https://camo.githubusercontent.com/e975ab71150c628666949ce3803e1e6d50e6045bd370850de3e2ae65f495aa20/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f36396264363065342d306335302d346465662d613564372d3665303531393761323663392e706e67" alt="" loading="lazy"> 因此，Konva 在创建 Layer 的时候会创建两个 Canvas，一个用于 sceneCanvas 用于绘制 Shape，另一个 hitCanvas 在内存里面，用于判断是否被打击。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>canvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SceneCanvas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hitCanvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HitCanvas</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">pixelRatio</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://camo.githubusercontent.com/352ea8233908db8e9464a7b814deb15ebf770b61c171ca4067da513109f29deb/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f35333735653761642d393835332d343236302d613265312d6631633263643738366662642e706e67" alt="" loading="lazy"> 当 Shape 初始化的时候，会生成一个随机的颜色，以这个颜色作为 key 存入到 shapes 数组里面。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token operator">?</span><span class="token operator">:</span> Config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// set colorKey</span>
    <span class="token keyword">let</span> <span class="token literal-property property">key</span><span class="token operator">:</span> string<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 生成随机色值</span>
      key <span class="token operator">=</span> Util<span class="token punctuation">.</span><span class="token function">getRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> shapes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>colorKey <span class="token operator">=</span> key<span class="token punctuation">;</span>
    <span class="token comment">// 存入 shapes 数组</span>
    shapes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每次在 sceneCanvas 上面绘制的时候，同样会在内存中的 hitCanvas 里面绘制一遍，并且将上面随机生成的色值作为 fill 和 stroke 的颜色填充。当点击 sceneCanvas 的时候，获取到点击的坐标点，通过调用 hitCanvas 的 <code>getImageData</code> 就可以获取到 colorKey，然后再通过 colorKey 就能找到对应的 Shape 了，真是相当巧妙的实现。 <img src="https://camo.githubusercontent.com/821609f511a6cd1760042d9fea1d66ce53deabed1e2628df0683b73e898cba16/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f62376437653336382d643833622d343765342d613234382d3734613732306133656665632e706e67" alt="" loading="lazy"> 但这种方式也有缺陷，因为生成的随机 hex 颜色是有上限的，最多会会有 256<em>256</em> 256 = 16777216 种，如果超过了这么多就会导致匹配不准确。不过考虑一下如果有 16777216 个 DOM 节点，浏览器就会卡爆了，换成这么多 Canvas 图形一样会导致性能爆炸。</p><h3 id="自定义-hitfunc" tabindex="-1"><a class="header-anchor" href="#自定义-hitfunc"><span>自定义 hitFunc</span></a></h3><p>如果你想自定义事件响应区域，Konva 也提供了 hitFunc 方法给你实现。在绘制 hitCanvas 的时候，原本的绘制 sceneFunc 就失效了，取而代之的是绘制 hitFunc。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  <span class="token function">drawHit</span><span class="token punctuation">(</span><span class="token parameter">can<span class="token operator">?</span><span class="token operator">:</span> HitCanvas<span class="token punctuation">,</span> top<span class="token operator">?</span><span class="token operator">:</span> Node<span class="token punctuation">,</span> skipDragCheck <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">shouldDrawHit</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> skipDragCheck<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> layer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      canvas <span class="token operator">=</span> can <span class="token operator">||</span> layer<span class="token punctuation">.</span>hitCanvas<span class="token punctuation">,</span>
      context <span class="token operator">=</span> canvas <span class="token operator">&amp;&amp;</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 如果有 hitFunc，就不使用 sceneFunc</span>
      drawFunc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hitFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sceneFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      cachedCanvas <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getCanvasCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      cachedHitCanvas <span class="token operator">=</span> cachedCanvas <span class="token operator">&amp;&amp;</span> cachedCanvas<span class="token punctuation">.</span>hit<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>colorKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Util<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">&#39;Looks like your canvas has a destroyed shape in it. Do not reuse shape after you destroyed it. If you want to reuse shape you should call remove() instead of destroy()&#39;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
    <span class="token function">drawFunc</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="拖拽事件" tabindex="-1"><a class="header-anchor" href="#拖拽事件"><span>拖拽事件</span></a></h3><p>Konva 的拖拽事件没有使用原生的方法，而是基于 mousemove 和 touchmove 来计算移动的距离，进而手动设置 Shape 的位置，实现逻辑比较简单，这里不细说。</p><h2 id="滤镜" tabindex="-1"><a class="header-anchor" href="#滤镜"><span>滤镜</span></a></h2><p>Konva 支持多种滤镜，在使用滤镜之前需要先将 Shape cache 起来，然后使用 <code>filter()</code> 方法添加滤镜。 在 cache 里面除了创建用于离屏渲染的 Canvas，还会创建滤镜 Canvas。滤镜处理在 <code>_getCachedSceneCanvas</code> 里面。 <img src="https://camo.githubusercontent.com/5736b6469b94b56d537b2a76c8999e3b307278d42527a4bb7f4d87f2b68357cd/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f39346434613735622d626262362d343861312d623036302d6165376530386164626130382e706e67" alt="" loading="lazy"> 首先将 sceneCanvas 通过 drawImage 绘制到 filterCanvas 上面，接着 filterCanvas 获取所有的 ImageData，遍历所有设置的滤镜方法，将 ImageData 传给滤镜方法来处理。处理完 ImageData 之后，再将其通过 putImageData 绘制到 filterCanvas 上面。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>filters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_filterUpToDate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ratio <span class="token operator">=</span> sceneCanvas<span class="token punctuation">.</span>pixelRatio<span class="token punctuation">;</span>
    filterCanvas<span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span>sceneCanvas<span class="token punctuation">.</span>width <span class="token operator">/</span> sceneCanvas<span class="token punctuation">.</span>pixelRatio<span class="token punctuation">,</span> sceneCanvas<span class="token punctuation">.</span>height <span class="token operator">/</span> sceneCanvas<span class="token punctuation">.</span>pixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      len <span class="token operator">=</span> filters<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      filterContext<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// copy cached canvas onto filter context</span>
      filterContext<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>
        sceneCanvas<span class="token punctuation">.</span>_canvas<span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        sceneCanvas<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> ratio<span class="token punctuation">,</span>
        sceneCanvas<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> ratio
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      imageData <span class="token operator">=</span> filterContext<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> filterCanvas<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filterCanvas<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// apply filters to filter context</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        filter <span class="token operator">=</span> filters<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> filter <span class="token operator">!==</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Util<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
            <span class="token string">&#39;Filter should be type of function, but got &#39;</span> <span class="token operator">+</span> <span class="token keyword">typeof</span> filter <span class="token operator">+</span> <span class="token string">&#39; instead. Please check correct filters&#39;</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">filter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> imageData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        filterContext<span class="token punctuation">.</span><span class="token function">putImageData</span><span class="token punctuation">(</span>imageData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Util<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
        <span class="token string">&#39;Unable to apply filter. &#39;</span> <span class="token operator">+</span>
          e<span class="token punctuation">.</span>message <span class="token operator">+</span>
          <span class="token string">&#39; This post my help you https://konvajs.org/docs/posts/Tainted_Canvas.html.&#39;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_filterUpToDate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> filterCanvas<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那滤镜效果怎么画上去的呢？在 konva 里面进行了特殊处理，如果存在 filterCanvas，那就不会使用 cacheCanvas 了，也就是我们原本用于缓存的离屏 Canvas 会被 filterCanvas 进行替代。最终 filterCanvas 会通过 drawImage 的方式绘制到 sceneCanvas 上面。</p><h2 id="选择器" tabindex="-1"><a class="header-anchor" href="#选择器"><span>选择器</span></a></h2><p>Konva 实现了选择器，方便我们快速查找到某个 Shape。目前主要有三种选择器，分别是 id 选择器、name 选择器、type 选择器。前两者需要在实例化的时候传入一个 id 或者 name 属性，后者则是根据类名（Rect、Line 等）来查找的。选择器查找的时候需要调用 find 方法，这个 find 方法挂载在 Container 类上面。它调用了 _descendants 进行子节点的遍历，将遍历的 node 节点调用 isMatch 方法来判断是否匹配上。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  _generalFind<span class="token operator">&lt;</span>ChildNode <span class="token keyword">extends</span> <span class="token class-name">Node</span> <span class="token operator">=</span> Node<span class="token operator">&gt;</span><span class="token punctuation">(</span>
    <span class="token literal-property property">selector</span><span class="token operator">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>
    <span class="token literal-property property">findOne</span><span class="token operator">:</span> boolean
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> <span class="token literal-property property">retArr</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>ChildNode<span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 调用 _descendants 获取所有的子节点</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_descendants</span><span class="token punctuation">(</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ChildNode<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
      <span class="token keyword">const</span> valid <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">_isMatch</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        retArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果是 findOne，后面的就不继续执行了</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>valid <span class="token operator">&amp;&amp;</span> findOne<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> retArr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">_descendants</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span>n<span class="token operator">:</span> Node<span class="token punctuation">)</span> <span class="token operator">=</span>boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> shouldStop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> child <span class="token keyword">of</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      shouldStop <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldStop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span><span class="token function">hasChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果子节点也有子节点，那就递归遍历</span>
      shouldStop <span class="token operator">=</span> <span class="token punctuation">(</span>child <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_descendants</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果应该停止查找（一般是 findOne 的时候就不需要查找后面的了）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldStop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 isMatch 里面可以看到后根据是什么类型的选择器来分别进行匹配。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// id selector</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>sel<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&#39;#&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sel<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&#39;.&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// name selector</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasName</span><span class="token punctuation">(</span>sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>className <span class="token operator">===</span> sel <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nodeType <span class="token operator">===</span> sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="序列化" tabindex="-1"><a class="header-anchor" href="#序列化"><span>序列化</span></a></h2><p>Konva 还支持对 Stage 的序列化和反序列化，简单来说就是把 Stage 的数据导出成一份 JSON 数据以及把 JSON 数据导入，方便我们在 NodeJS 端进行服务端渲染。序列化主要在 toObject 方法里面，它会对函数和 DOM 节点进行过滤，只保留一份描述信息，比如 Layer 的信息、Shape 的信息等等，有点儿类似 React 里面的 Virtual DOM。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  <span class="token function">toObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> any<span class="token punctuation">,</span>
      attrs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      key<span class="token punctuation">,</span>
      val<span class="token punctuation">,</span>
      getter<span class="token punctuation">,</span>
      defaultValue<span class="token punctuation">,</span>
      nonPlainObject<span class="token punctuation">;</span>

    obj<span class="token punctuation">.</span>attrs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      val <span class="token operator">=</span> attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      nonPlainObject <span class="token operator">=</span>
        Util<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Util<span class="token punctuation">.</span><span class="token function">_isPlainObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Util<span class="token punctuation">.</span><span class="token function">_isArray</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nonPlainObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      getter <span class="token operator">=</span> <span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">delete</span> attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 特殊处理函数，将其执行后把结果挂载到当前key上面</span>
      defaultValue <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// restore attr value</span>
      attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultValue <span class="token operator">!==</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        obj<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    obj<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Util<span class="token punctuation">.</span><span class="token function">_prepareToStringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而反序列化则是对传入的 JSON 信息进行解析，根据 className 来创建不同的对象，对深层结构进行递归，然后 add 到父节点里面。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  <span class="token keyword">static</span> <span class="token function">_createNode</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> container<span class="token operator">?</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> className <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span>
      children <span class="token operator">=</span> obj<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
      no<span class="token punctuation">,</span>
      len<span class="token punctuation">,</span>
      n<span class="token punctuation">;</span>

    <span class="token comment">// if container was passed in, add it to attrs</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      obj<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span>container <span class="token operator">=</span> container<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Konva<span class="token punctuation">[</span>className<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Util<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">&#39;Can not find a node with class name &quot;&#39;</span> <span class="token operator">+</span>
          className <span class="token operator">+</span>
          <span class="token string">&#39;&quot;. Fallback to &quot;Shape&quot;.&#39;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      className <span class="token operator">=</span> <span class="token string">&#39;Shape&#39;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 根据传入的 className 来实例化</span>
    <span class="token keyword">const</span> Class <span class="token operator">=</span> Konva<span class="token punctuation">[</span>className<span class="token punctuation">]</span><span class="token punctuation">;</span>

    no <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      len <span class="token operator">=</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果还有子节点，那就递归创建</span>
        no<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Node<span class="token punctuation">.</span><span class="token function">_createNode</span><span class="token punctuation">(</span>children<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> no<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="react" tabindex="-1"><a class="header-anchor" href="#react"><span>React</span></a></h2><p>Konva 和 React 绑定没有使用重新封装一遍组件的方式，而是采用了和 react-dom、react-native 一样的形式，基于 react-reconciler 来实现一套 hostConfig，从而定制自己的 Host Component（宿主组件）。</p><h3 id="react-reconciler" tabindex="-1"><a class="header-anchor" href="#react-reconciler"><span>react-reconciler</span></a></h3><p>React Fiber 架构诞生之后，他们就将原来的 React 核心代码做了抽离。主要包括 react、react-reconciler 和 platform 实现（react-dom、react-native 等）三部分。在 react-reconciler 里面实现了大名鼎鼎的 Diff 算法、时间切片、调度等等，它还暴露给了我们一个 hostConfig 文件，允许我们在各种钩子函数中实现自己的渲染。在 React 里面，有两种组件类型，一种是 Host Component（宿主组件），另一种是 Composition Component（复合组件）。在 DOM 里面，前者就是 h1、div、span 等元素，在 react-native 里面，前者就是 View、Text、ScrollView 等元素。后者则是我们基于 Host Component 自定义的组件，比如 App、Header 等等。在 react-reconciler 里面，它允许我们去自定义 Host Component 的渲染（增删查改），这也意味着跨平台的能力。我们只需要编写一份 hostConfig 文件，就能够实现自己的渲染。 <img src="https://camo.githubusercontent.com/695f54a7f71577ec66604e45270bc623eabb928e823bcce2b564d636de17997a/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f64333463333963632d386464312d346239382d613933332d6533633338303164643739332e706e67" alt="" loading="lazy"> 参考上面的架构图，会发现不管是渲染到 native、canvas，甚至是小程序都可以。业界已经有方案是基于这个来实现了，可以参考蚂蚁金服的 remax：<a href="https://zhuanlan.zhihu.com/p/79788488" target="_blank" rel="noopener noreferrer">Remax - 使用真正的 React 构建小程序<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="react-konva" tabindex="-1"><a class="header-anchor" href="#react-konva"><span>react-konva</span></a></h3><p>react-konva 的主要实现就在 ReactKonvaHostConfig.js 里面，它利用 Konva 原本的 API 实现了对 Virtual DOM 的映射，响应了 Virtual DOM 的增删查改。这里从中抽取了部分源码：</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// 创建一个实例</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> internalInstanceHandle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> NodeClass <span class="token operator">=</span> Konva<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> propsWithoutEvents <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> propsWithOnlyEvents <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> isEvent <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&#39;on&#39;</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      propsWithOnlyEvents<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      propsWithoutEvents<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 根据传入的 type 来创建一个实例，相当于 new Layer、new Rect 等</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeClass</span><span class="token punctuation">(</span>propsWithoutEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将传入的 props 设置到实例上面</span>
  <span class="token comment">// 如果是普通的 prop，就直接通过 instance.setAttr 更新</span>
  <span class="token comment">// 如果是 onClick 之类的事件，就通过 instance.on 来绑定</span>
  <span class="token function">applyNodeProps</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> propsWithOnlyEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 插入子节点，直接调用 konva 的 add 方法</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token parameter">parentInstance<span class="token punctuation">,</span> child</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>parent <span class="token operator">===</span> parentInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    child<span class="token punctuation">.</span><span class="token function">moveToTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    parentInstance<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">updatePicture</span><span class="token punctuation">(</span>parentInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 移除子节点，直接调用 destroy 方法</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">removeChild</span><span class="token punctuation">(</span><span class="token parameter">parentInstance<span class="token punctuation">,</span> child</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  child<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  child<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token constant">EVENTS_NAMESPACE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">updatePicture</span><span class="token punctuation">(</span>parentInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 通过设置 zIndex 实现 insertBefore</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token parameter">parentInstance<span class="token punctuation">,</span> child<span class="token punctuation">,</span> beforeChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// child._remove() will not stop dragging</span>
  <span class="token comment">// but child.remove() will stop it, but we don&#39;t need it</span>
  <span class="token comment">// removing will reset zIndexes</span>
  child<span class="token punctuation">.</span><span class="token function">_remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  parentInstance<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  child<span class="token punctuation">.</span><span class="token function">setZIndex</span><span class="token punctuation">(</span>beforeChild<span class="token punctuation">.</span><span class="token function">getZIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">updatePicture</span><span class="token punctuation">(</span>parentInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="vue-konva" tabindex="-1"><a class="header-anchor" href="#vue-konva"><span>vue-konva</span></a></h2><p>在 Vue 上面，Konva 通过 Vue.use 注册了一个插件，这个插件里面分别注册了每个组件。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">const</span> components <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Stage&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">component</span><span class="token operator">:</span> Stage
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span><span class="token constant">KONVA_NODES</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>name <span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">,</span>
    <span class="token literal-property property">component</span><span class="token operator">:</span> <span class="token function">KonvaNode</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> VueKonva <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">install</span><span class="token operator">:</span> <span class="token punctuation">(</span>Vue<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> prefixToUse <span class="token operator">=</span> componentPrefix<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>prefix<span class="token punctuation">)</span><span class="token punctuation">{</span>
      prefixToUse <span class="token operator">=</span> options<span class="token punctuation">.</span>prefix<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    components<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>k <span class="token operator">=</span><span class="token punctuation">{</span>
      Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixToUse<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> k<span class="token punctuation">.</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> VueKonva<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueKonva<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再来看看 KonvaNode 的实现，在 KonvaNode 里面，对于节点的增删查改都在 Vue 的生命周期里面实现的。 在 Vue 的 created 生命周期里面调用 initKonva 去 new 一个 NodeClass，和上面 React 的方式几乎一样。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>      <span class="token function">initKonva</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> NodeClass <span class="token operator">=</span> window<span class="token punctuation">.</span>Konva<span class="token punctuation">[</span>nameNode<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>NodeClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;vue-konva error: Can not find node &#39;</span> <span class="token operator">+</span> nameNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>_konvaNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_konvaNode<span class="token punctuation">.</span>VueComponent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">uploadKonva</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而在 Updated 的时候去进行 Props 的更新，在 destroyed 里面对节点进行 destroy，实现上更加简洁一些。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>    <span class="token function">updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">uploadKonva</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">checkOrder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$vnode<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_konvaNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">destroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">updatePicture</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_konvaNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_konvaNode<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_konvaNode<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token constant">EVENTS_NAMESPACE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="缺陷" tabindex="-1"><a class="header-anchor" href="#缺陷"><span>缺陷</span></a></h2><h3 id="脏矩形" tabindex="-1"><a class="header-anchor" href="#脏矩形"><span>脏矩形</span></a></h3><p>在性能方面，Konva 对比 PIXI、ZRender 这些库还是不太够看。如果我们 Layer 上有非常多的 Shape，如果想更新某个 Shape，按照 Konva 的实现方式依然会全量绘制。虽然 Konva 支持单个 Shape 重绘，但实现上是无脑覆盖原来的位置，这也意味着如果你的图形在其他节点图形下面，就会出现问题。所以这里缺少非常重要的局部更新能力，也就是我们常说的脏矩形。脏矩形就是指当我们更新一个 Shape 的时候，利用碰撞检测计算出和他相交的所有 Shape，将其进行合并，计算出一块儿脏区域。然后我们通过 clip 限制 Canvas 只在这块儿脏区进行绘制，这样就实现了局部更新。 <img src="https://camo.githubusercontent.com/0c8f0933195af9f1afa41f3f2a373158a101454f3c36c8a585eee32337a9f33c/68747470733a2f2f66696c65732e6d646e6963652e636f6d2f757365722f343537372f63616536613739652d623937312d343238392d393432652d6536303539366537303432362e706e67" alt="" loading="lazy"> 可惜 Konva 的包围盒实现的非常简单，不适合做碰撞检测，它也没有提供脏矩形的能力。</p></div><!--[--><!----><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/h7ml/h7ml/edit/main/h7ml/posts/graphics/konva.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: h7ml@qq.com">h7ml</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link nav-link prev" href="/posts/graphics/fabric.html" aria-label="fabric"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><span class="font-icon icon iconfont icon-card" style=""></span>fabric</div></a><!----></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer"><a href='https://v6.51.la/s/N6M38h8J5TZZXKh' id="LA-DATA-WIDGET" target='blank'>51.la</a><a href='https://beian.mit.gov.cn/' target='blank'>浙ICP备2021037683号-2</a></div><div class="vp-copyright">Copyright © 2024 h7ml </div></footer></div><!--]--><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-Cbix2SPG.js" defer></script>
  </body>
</html>
